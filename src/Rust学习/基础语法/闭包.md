# å‡½æ•°ä¸é—­åŒ…

## ä¸€ã€ å‡½æ•° (Functions)

å‡½æ•°æ˜¯ Rust ä»£ç çš„é™æ€éª¨æ¶ã€‚å®ƒä»¬å¿…é¡»åœ¨ç¼–è¯‘æ—¶æ‹¥æœ‰æ˜ç¡®çš„ç­¾åã€‚

### 1. åŸºç¡€è¯­æ³•ä¸æ˜¾å¼è¿”å›

Rust çš„å‡½æ•°å‚æ•°å¿…é¡»æ ‡æ³¨ç±»å‹ï¼Œè¿”å›ç±»å‹ä½¿ç”¨ `->` æ ‡æ³¨ã€‚

```rust,editable
// é€»è¾‘æ¦‚æ‹¬ï¼šå‚æ•°å¿…é¡»æ˜¾å¼æ³¨æ˜ç±»å‹ï¼Œæœ€åä¸€è¡Œè¡¨è¾¾å¼ä½œä¸ºè¿”å›å€¼
fn calculate_score(points: i32, multiplier: i32) -> i32 {
    if points < 0 {
        return 0; // ä½¿ç”¨ return æå‰é€€å‡º
    }
    points * multiplier // éšå¼è¿”å›ï¼ˆæ— åˆ†å·ï¼‰
}
fn main() {
    let score = calculate_score(10, 3);
    println!("æœ€ç»ˆå¾—åˆ†: {score}");
}
```

### 2. å‡½æ•°æŒ‡é’ˆ (`fn` ç±»å‹)

å‡½æ•°æœ¬èº«å¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨åœ¨å˜é‡ä¸­ã€‚å®ƒçš„ç±»å‹æ˜¯å°å†™çš„ `fn`ã€‚

```rust,editable
fn add_one(x: i32) -> i32 { x + 1 }

fn do_math(f: fn(i32) -> i32, value: i32) -> i32 {
    f(value)
}

fn main() {
    let result = do_math(add_one, 5);
    println!("å‡½æ•°æŒ‡é’ˆè°ƒç”¨ç»“æœ: {result}"); // 6
}
```

---

## äºŒã€ é—­åŒ… (Closures)

`Rust` ä¸­çš„é—­åŒ…ï¼ˆ`closures`ï¼‰æ˜¯ä¸€ç§åŒ¿åå‡½æ•°ï¼Œå¯ä»¥æ•è·å…¶ç¯å¢ƒä¸­çš„å˜é‡ã€‚é—­åŒ…ç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­çš„ `lambda` è¡¨è¾¾å¼ï¼Œä½† `Rust` çš„é—­åŒ…ç³»ç»Ÿä¸æ‰€æœ‰æƒå’Œå€Ÿç”¨ç´§å¯†é›†æˆï¼Œç¡®ä¿å†…å­˜å®‰å…¨ã€‚é—­åŒ…å¯ä»¥ä½œä¸ºå‡½æ•°å‚æ•°ã€è¿”å›å€¼ï¼Œæˆ–å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œå¸¸ç”¨äºè¿­ä»£å™¨ã€çº¿ç¨‹å’Œå›è°ƒã€‚`Rust` é—­åŒ…å®ç°äº†`Fn trait` å®¶æ—ï¼ˆ`Fnã€FnMutã€FnOnce`ï¼‰ï¼Œæ ¹æ®æ•è·æ–¹å¼å†³å®šå…¶è¡Œä¸ºã€‚æœ€æ ¸å¿ƒçš„ç‰¹æ€§æ˜¯ **æ•è·ç¯å¢ƒ** ã€‚å®ƒä»¬é€šå¸¸æ¯”å‡½æ•°æ›´ç®€æ´ï¼Œä¸”æ”¯æŒç±»å‹æ¨å¯¼ã€‚

### 1. è¯­æ³•ä¸è‡ªåŠ¨æ¨å¯¼

é—­åŒ…ä¸å¼ºåˆ¶å†™ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®ç¬¬ä¸€æ¬¡è°ƒç”¨çš„ä¸Šä¸‹æ–‡é”å®šç±»å‹ã€‚è¯­æ³•ï¼š`|params| expression` æˆ– `{ body }`ã€‚

```rust,editable
fn main() {
    // é—­åŒ…æ ‡å‡†è¯­æ³•
    let closure_annotated = |x: i32| -> i32 { x + 1 };
  
    // è‡ªåŠ¨æ¨å¯¼ç®€å†™
    let closure_inferred = |x| x + 1;

    println!("{}", closure_annotated(1));
    println!("{}", closure_inferred(1));
}
```

### 2. æ•è·æ–¹å¼ï¼šä¸å¯å˜ã€å¯å˜ã€ç§»åŠ¨

é—­åŒ…é€šè¿‡ä¸‰ç§æ–¹å¼ä»ä½œç”¨åŸŸæ•è·å˜é‡ï¼š

* **ä¸å¯å˜å€Ÿç”¨ (`&T`)** ï¼šé»˜è®¤æ–¹å¼ã€‚
* **å¯å˜å€Ÿç”¨ (`&mut T`)** ï¼šå½“é—­åŒ…å†…éƒ¨ä¿®æ”¹å˜é‡æ—¶ã€‚
* **ç§»åŠ¨æ‰€æœ‰æƒ (`T`)** ï¼šä½¿ç”¨ `move` å…³é”®å­—ï¼Œå¸¸ç”¨äºå¼‚æ­¥æˆ–å¤šçº¿ç¨‹ã€‚

```rust,editable
fn main() {
    let x = 4;
    let equal_to_x = |z| z == x;  // å€Ÿç”¨ x (&x)
    println!("ç›¸ç­‰ï¼Ÿ{}", equal_to_x(4));  // è¾“å‡º: ç›¸ç­‰ï¼Ÿtrue
    println!("x ä»æœ‰æ•ˆ: {}", x);  // x æœªç§»åŠ¨
    //å¯å˜å€Ÿç”¨
    let mut count = 0;
    let mut inc = || {
        count += 1; // è‡ªåŠ¨æ¨å¯¼ä¸º å¯å˜å€Ÿç”¨
        println!("å½“å‰è®¡æ•°: {count}");
    };
    inc();
    inc();
    // å¼ºåˆ¶ç§»åŠ¨æ‰€æœ‰æƒ
    let text = String::from("hello");
    let print_text = move || println!("ç§»åŠ¨åçš„æ–‡æœ¬: {text}");
    print_text();
    // println!("{text}"); // âŒ æŠ¥é”™ï¼štext å·²ç§»åŠ¨åˆ°é—­åŒ…ä¸­
}
```

---

## ä¸‰ã€ é—­åŒ…ç‰¹å¾ (Fn, FnMut, FnOnce)

å½“é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨è¿™ä¸‰ä¸ª Trait æ¥çº¦æŸå®ƒï¼š

* **`FnOnce`** ï¼šè°ƒç”¨ä¸€æ¬¡ï¼Œæ¶ˆè€—é—­åŒ…ï¼ˆå¯èƒ½ç§»åŠ¨æ•è·ï¼‰ã€‚
* **`FnMut`** ï¼šå¯å¤šæ¬¡è°ƒç”¨ï¼Œå¯ä¿®æ”¹æ•è·ã€‚
* **`Fn`** ï¼šå¯å¤šæ¬¡è°ƒç”¨ï¼Œåªè¯»æ•è·ã€‚

```rust,editable
fn run_once<F>(f: F) where F: FnOnce() {
    f();
}

fn main() {
    let s = String::from("once");
    let consume_s = || drop(s); // è¯¥é—­åŒ…æ¶ˆè´¹äº† s çš„æ‰€æœ‰æƒ
  
    run_once(consume_s);
    // run_once(consume_s); // âŒ æŠ¥é”™ï¼šé—­åŒ…å·²è¢«æ¶ˆè´¹
}
```

---

## å››ã€ é«˜çº§è¿›é˜¶ï¼šå‡½æ•°ä¸é—­åŒ…ä½œä¸ºè¿”å›å€¼

è¿™æ˜¯ Rust ä¸­æœ€å…·çµæ´»æ€§çš„éƒ¨åˆ†ã€‚ç”±äºé—­åŒ…æ²¡æœ‰å…·ä½“çš„åå­—ï¼Œè¿”å›å®ƒä»¬éœ€è¦ç‰¹æ®Šçš„å¤„ç†ã€‚

### 1. è¿”å›æ™®é€šå‡½æ•°æŒ‡é’ˆ (`fn`)

é€‚ç”¨äºé€»è¾‘å›ºå®šã€ä¸æ•è·å¤–éƒ¨å˜é‡çš„æƒ…å†µã€‚

```rust,editable
fn apply<F>(f: F, x: i32) -> i32
where
    F: FnOnce(i32) -> i32,  // bound FnOnce
{
    f(x)
}

fn main() {
    let double = |n| n * 2;
    println!("ç»“æœ: {}", apply(double, 5));  // è¾“å‡º: ç»“æœ: 10
}
```

### 2. è¿”å›é—­åŒ…ï¼šé™æ€åˆ†å‘ (`impl Trait`)

è¿™æ˜¯è¿”å›é—­åŒ…æœ€å¸¸ç”¨çš„æ–¹å¼ã€‚å®ƒæ•ˆç‡é«˜ï¼ˆæ— å †åˆ†é…ï¼‰ï¼Œä½†è¦æ±‚æ‰€æœ‰åˆ†æ”¯è¿”å›**åŒä¸€ç§**é—­åŒ…ã€‚

```rust,editable
fn create_multiplier(factor: i32) -> impl Fn(i32) -> i32 {
    // å…³é”®ï¼šå¿…é¡»ä½¿ç”¨ moveï¼Œå°† factor ç§»å…¥é—­åŒ…
    // å¦åˆ™ factor ä¼šåœ¨å‡½æ•°ç»“æŸæ—¶é‡Šæ”¾ï¼Œå¯¼è‡´å¼•ç”¨å¤±æ•ˆ
    move |x| x * factor
}

fn main() {
    let double = create_multiplier(2);
    println!("3 çš„ä¸¤å€æ˜¯: {}", double(3));
}
```

### 3. è¿”å›é—­åŒ…ï¼šåŠ¨æ€åˆ†å‘ (`Box<dyn Trait>`)

å¦‚æœä½ éœ€è¦æ ¹æ®é€»è¾‘è¿”å›ä¸åŒçš„é—­åŒ…ï¼ˆæ¯”å¦‚åœ¨ `if/else` åˆ†æ”¯ä¸­è¿”å›ä¸åŒçš„é—­åŒ…ä»£ç å—ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨ `Box`ã€‚

```rust,editable
fn get_closure(mode: bool) -> Box<dyn Fn(i32) -> i32> {
    if mode {
        Box::new(|x| x + 1)
    } else {
        Box::new(|x| x * 2)
    }
}

fn main() {
    let f = get_closure(false);
    println!("æ‰§è¡Œç»“æœ: {}", f(5)); // 10
}
```

---

## æ€»ç»“å¯¹æ¯”

| **ç‰¹æ€§** | **æ™®é€šå‡½æ•° (fn)** | **impl Trait é—­åŒ…** | **`Box<dyn Trait>` é—­åŒ…** |
| --- | --- | --- | --- |
| **æ•è·å˜é‡** | ä¸æ”¯æŒ | æ”¯æŒï¼ˆéœ€ç”¨ `move`ï¼‰ | æ”¯æŒï¼ˆéœ€ç”¨ `move`ï¼‰ |
| **è¿”å›ç±»å‹** | `fn(A) -> B` | `impl Fn(A) -> B` | `Box<dyn Fn(A) -> B>` |
| **å†…å­˜ä½ç½®** | ä»£ç æ®µ | æ ˆ | å † |
| **æ€§èƒ½** | æé«˜ï¼ˆé™æ€ï¼‰ | é«˜ï¼ˆé™æ€ï¼‰ | ç•¥ä½ï¼ˆåŠ¨æ€å¯»å€ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•ã€çº¯ç²¹çš„é€»è¾‘ | æ€§èƒ½æ•æ„Ÿã€å•ä¸€è¿”å›è·¯å¾„ | éœ€è¦æ ¹æ®æ¡ä»¶è¿”å›ä¸åŒé—­åŒ… |

---

### ğŸ’¡ æ ¸å¿ƒé¿å‘æŒ‡å—

åœ¨è¿”å›é—­åŒ…æ—¶ï¼Œ**å¿˜è®°å†™ `move`** æ˜¯æ–°æ‰‹æœ€å¸¸è§çš„é”™è¯¯ã€‚

> **è®°ä½** ï¼šé—­åŒ…é»˜è®¤ä¼šå°è¯•é€šè¿‡â€œå¼•ç”¨â€æ¥æ•è·ç¯å¢ƒä¸­çš„å˜é‡ã€‚ä½†å½“å‡½æ•°ç»“æŸæ—¶ï¼Œè¿™äº›å˜é‡ä¼šè¢«é”€æ¯ï¼Œæ‰€ä»¥é—­åŒ…å¿…é¡»é€šè¿‡ `move` æŠŠå®ƒä»¬â€œæ‰“åŒ…å¸¦èµ°â€ï¼Œå¦åˆ™ä½ ä¼šå¾—åˆ°ä¸€ä¸ªâ€œæ‚¬å‚å¼•ç”¨â€çš„æŠ¥é”™ã€‚
