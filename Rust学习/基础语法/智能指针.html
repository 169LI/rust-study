<!DOCTYPE HTML>
<html lang="zh-CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>æ™ºèƒ½æŒ‡é’ˆ - Rust study</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../../css/general-2459343d.css">
        <link rel="stylesheet" href="../../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../custom-7e8a6fc2.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex-68d2e57e.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc-2a4c8e05.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust study</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/169li/rust-study" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/169li/rust-study/edit/master/src/Rustå­¦ä¹ /åŸºç¡€è¯­æ³•/æ™ºèƒ½æŒ‡é’ˆ.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ</a></h1>
<p>Rust é‡Œâ€œæ™ºèƒ½æŒ‡é’ˆâ€è¿™å—ï¼ŒæŒ‰ <strong>â€œå®ƒè§£å†³ä»€ä¹ˆé—®é¢˜ + å®ƒçš„æ‰€æœ‰æƒ/å€Ÿç”¨è§„åˆ™ + è¿è¡Œæ—¶æˆæœ¬â€</strong> æ¥ç³»ç»Ÿå­¦ã€‚ä¸‹é¢æŠŠéœ€è¦æŒæ¡çš„çŸ¥è¯†ç‚¹å°½é‡å…¨åˆ—å‡ºæ¥ï¼Œå¹¶æŒ‰å­¦ä¹ è·¯å¾„ç»„ç»‡ã€‚</p>
<hr>
<h2 id="å®šä¹‰"><a class="header" href="#å®šä¹‰">å®šä¹‰</a></h2>
<h3 id="ä»€ä¹ˆç®—æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#ä»€ä¹ˆç®—æ™ºèƒ½æŒ‡é’ˆ">ä»€ä¹ˆç®—â€œæ™ºèƒ½æŒ‡é’ˆâ€</a></h3>
<ul>
<li><strong>æ™ºèƒ½æŒ‡é’ˆ vs æ™®é€šå¼•ç”¨ <code>&amp;T</code> / <code>&amp;mut T</code></strong> ï¼šæ™ºèƒ½æŒ‡é’ˆæ˜¯â€œåƒæŒ‡é’ˆä¸€æ ·ç”¨ï¼ˆ<code>Deref</code>ï¼‰+ è¿˜å¸¦ç®¡ç†/ç­–ç•¥â€çš„ç±»å‹</li>
<li>ä¸‰ä¸ªæ ¸å¿ƒ traitï¼š
<ul>
<li><code>Deref</code> / <code>DerefMut</code>ï¼šè®© <code>*p</code>ã€æ–¹æ³•è°ƒç”¨ã€è§£å¼•ç”¨è‡ªåŠ¨è½¬æ¢æˆç«‹</li>
<li><code>Drop</code>ï¼šç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨æ¸…ç†èµ„æºï¼ˆRAIIï¼‰</li>
<li><code>CoerceUnsized</code>/<code>DispatchFromDyn</code>ï¼ˆäº†è§£å³å¯ï¼‰ï¼š<code>Box&lt;T&gt;</code> åˆ° <code>Box&lt;dyn Trait&gt;</code> çš„ä¸å®šå¤§å°è½¬æ¢ç­‰</li>
</ul>
</li>
</ul>
<p>è¦ç†è§£ä¸ºä»€ä¹ˆ <code>Box</code> æˆ– <code>String</code> æ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œå¿…é¡»å…ˆçœ‹å®ƒä»¬èƒŒåçš„ä¸¤ä¸ªå…³é”®ç‰¹å¾ã€‚æ™ºèƒ½æŒ‡é’ˆæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å®ç°äº† <code>Deref</code> å’Œ <code>Drop</code> çš„ç»“æ„ä½“</strong>ã€‚</p>
<h3 id="a-deref-ç‰¹å¾è®©ç»“æ„ä½“åƒæŒ‡é’ˆ"><a class="header" href="#a-deref-ç‰¹å¾è®©ç»“æ„ä½“åƒæŒ‡é’ˆ">A. <code>Deref</code> ç‰¹å¾ï¼šè®©ç»“æ„ä½“â€œåƒâ€æŒ‡é’ˆ</a></h3>
<p>æ™®é€šçš„ç»“æ„ä½“ä¸èƒ½è¢«è§£å¼•ç”¨ï¼ˆå³ä¸èƒ½ç”¨ <code>*</code>ï¼‰ã€‚å®ç°äº† <code>Deref</code> ä¹‹åï¼Œæ™ºèƒ½æŒ‡é’ˆå°±å¯ä»¥åƒæ™®é€šå¼•ç”¨ä¸€æ ·å·¥ä½œã€‚</p>
<ul>
<li><strong>è§£å¼•ç”¨å¼ºåˆ¶è½¬æ¢ (Deref Coercion)</strong>ï¼šè¿™æ˜¯ <code>Rust</code> çš„é­”æ³•ã€‚å¦‚æœä¸€ä¸ªå‡½æ•°éœ€è¦ <code>&amp;str</code> å‚æ•°ï¼Œä½ ä¼ ç»™å®ƒ <code>&amp;String</code>ï¼ˆ<code>String</code>å®ç°äº† <code>Deref</code>ï¼‰ï¼Œ<code>Rust</code>ä¼šè‡ªåŠ¨å¸®ä½ è½¬æ¢ã€‚</li>
</ul>
<pre class="playground"><code class="language-rust editable edition2024">use std::ops::Deref;
struct MyBox&lt;T&gt;(T);
impl&lt;T&gt; MyBox&lt;T&gt; {
    fn new(x: T) -&gt; MyBox&lt;T&gt; {
        MyBox(x)
    }
}
// å®ç° Deref å‘Šè¯‰ç¼–è¯‘å™¨ï¼šå½“æˆ‘å¯¹ MyBox ä½¿ç”¨ * æ—¶ï¼Œè¿”å›å†…éƒ¨çš„é‚£ä¸ªå€¼
impl&lt;T&gt; Deref for MyBox&lt;T&gt; {
    type Target = T;
    fn deref(&amp;self) -&gt; &amp;T {
        &amp;self.0
    }
}
fn main() {
    let x = 5;
    let y = MyBox::new(x);

    assert_eq!(5, x);
    assert_eq!(5, *y); // è¿™é‡Œçš„ *y å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯ *(y.deref())
    println!("{}", *y); 
}
</code></pre>
<h3 id="b-drop-ç‰¹å¾è‡ªåŠ¨æ¸…ç†çš„ææ„å‡½æ•°"><a class="header" href="#b-drop-ç‰¹å¾è‡ªåŠ¨æ¸…ç†çš„ææ„å‡½æ•°">B. <code>Drop</code> ç‰¹å¾ï¼šè‡ªåŠ¨æ¸…ç†çš„â€œææ„å‡½æ•°â€</a></h3>
<p><code>Drop</code> ç‰¹å¾å…è®¸ä½ è‡ªå®šä¹‰ï¼šå½“ä¸€ä¸ªå˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶è¯¥å‘ç”Ÿä»€ä¹ˆã€‚å¯¹äºæ™ºèƒ½æŒ‡é’ˆï¼Œè¿™é€šå¸¸æ„å‘³ç€<strong>é‡Šæ”¾å®ƒæ‰€æ‹¥æœ‰çš„å †å†…å­˜</strong>ã€‚</p>
<ul>
<li><strong>è‡ªåŠ¨è°ƒç”¨</strong>ï¼šä½ ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>drop</code>ï¼ŒRust ä¼šè‡ªåŠ¨åœ¨å˜é‡ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶æ’å…¥æ¸…ç†ä»£ç ã€‚</li>
<li><strong>é˜²æ­¢æ³„æ¼</strong>ï¼šæœ‰äº† <code>Drop</code>ï¼ŒRust ç¡®ä¿äº†å³ä¾¿ç¨‹åºåœ¨ä¸­é—´å‡ºé”™é€€å‡ºï¼Œå †å†…å­˜ä¹Ÿä¼šè¢«æ­£ç¡®å›æ”¶ã€‚</li>
</ul>
<pre class="playground"><code class="language-rust editable edition2024">struct CustomSmartPointer {
    data: String,
}
impl Drop for CustomSmartPointer {
    fn drop(&amp;mut self) {
        println!("æ­£åœ¨æ¸…ç†æ•°æ®: {}ï¼", self.data);
    }
}
fn main() {
    let c = CustomSmartPointer { data: String::from("æˆ‘çš„æ•°æ®") };
    let d = CustomSmartPointer { data: String::from("å…¶ä»–æ•°æ®") };
    println!("æ™ºèƒ½æŒ‡é’ˆå·²åˆ›å»ºã€‚");
    // å‡½æ•°ç»“æŸæ—¶ï¼Œd å…ˆè¢«æ¸…ç†ï¼Œc åè¢«æ¸…ç†ï¼ˆå…ˆè¿›åå‡ºï¼‰
}
</code></pre>
<p>æ™ºèƒ½æŒ‡é’ˆé€šè¿‡ <code>Deref</code> è®©æˆ‘ä»¬èƒ½æ–¹ä¾¿åœ°è®¿é—®æ•°æ®ï¼Œé€šè¿‡ <code>Drop</code> è®©æˆ‘ä»¬ä¸å†æ‹…å¿ƒå†…å­˜å›æ”¶ã€‚</p>
<hr>
<h2 id="1-boxtå †åˆ†é…--é€’å½’ç±»å‹"><a class="header" href="#1-boxtå †åˆ†é…--é€’å½’ç±»å‹">1. <code>Box&lt;T&gt;</code>ï¼šå †åˆ†é… &amp; é€’å½’ç±»å‹</a></h2>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li><strong>ä»€ä¹ˆæ—¶å€™éœ€è¦ <code>Box</code></strong>
<ul>
<li>æŠŠå€¼æ”¾åˆ°<strong>å †</strong>ä¸Šï¼ˆå­˜å‚¨å®é™…çš„æ•°æ® <code>T</code>ï¼‰,è€Œåœ¨<strong>æ ˆ</strong>(å­˜å‚¨æŒ‡é’ˆåœ°å€,64 ä½ç³»ç»Ÿé€šå¸¸æ˜¯8å­—èŠ‚ï¼‰ä¸Šä»…ä¿ç•™ä¸€ä¸ªæŒ‡å‘å †æ•°æ®çš„æŒ‡é’ˆ</li>
<li>å¤„ç†  <strong>é€’å½’ç±»å‹</strong> ï¼ˆç¼–è¯‘æœŸéœ€è¦çŸ¥é“æ¯ä¸ªç±»å‹å ç”¨å¤šå°‘å†…å­˜ç©ºé—´â€“å¦‚ï¼šé“¾è¡¨ï¼‰</li>
<li>ä½œä¸º <strong>trait object</strong> çš„æŒæœ‰è€…ï¼šå½“ä½ éœ€è¦ä¸€ä¸ªâ€œå®ç°äº†æŸä¸ªç‰¹å¾çš„ç±»å‹â€è€Œä¸æ˜¯å…·ä½“ç±»å‹æ—¶ï¼Œé€šå¸¸ä½¿ç”¨<code>Box&lt;dyn Trait&gt;</code></li>
<li>è½¬ç§»å¤§æ•°æ®æ‰€æœ‰æƒ,å¦‚æœä½ æœ‰ä¸€ä¸ªéå¸¸å¤§çš„ç»“æ„ä½“æˆ–æ•°ç»„ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°æ—¶ï¼Œå¦‚æœä¸ä½¿ç”¨æŒ‡é’ˆï¼Œ<code>Rust</code>é»˜è®¤ä¼šè¿›è¡Œæ ˆæ‹·è´ï¼Œè¿™éå¸¸æ¶ˆè€—æ€§èƒ½ã€‚</li>
</ul>
</li>
<li><strong>æ‰€æœ‰æƒè¯­ä¹‰</strong> ï¼š<code>Box&lt;T&gt;</code> ç‹¬å æ‰€æœ‰æƒï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª <code>Box</code> æŒ‡å‘è¯¥å †æ•°æ®,ç§»åŠ¨ååŸå˜é‡ä¸å¯ç”¨</li>
<li><strong>è§£å¼•ç”¨ä¸æ–¹æ³•è°ƒç”¨</strong> ï¼š<code>Box&lt;T&gt;</code> è‡ªåŠ¨ <code>Deref</code> åˆ° <code>T</code></li>
</ul>
<h3 id="ç¤ºä¾‹é€’å½’ç±»å‹é“¾è¡¨"><a class="header" href="#ç¤ºä¾‹é€’å½’ç±»å‹é“¾è¡¨">ç¤ºä¾‹ï¼šé€’å½’ç±»å‹ï¼ˆé“¾è¡¨ï¼‰</a></h3>
<pre><code class="language-rust ignore">enum List {
    Cons(i32, List), // é”™è¯¯ï¼šList åŒ…å« Listï¼Œä¼šå¯¼è‡´æ— é™å¤§å°
    Nil,
}</code></pre>
<p>ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸º Cons å˜ä½“åŒ…å«å¦ä¸€ä¸ª <code>List</code>ï¼Œè¿™ä¼šå½¢æˆæ— é™é€’å½’ï¼Œç¼–è¯‘å™¨æ— æ³•è®¡ç®— <code>List</code> ç»“æ„çš„å¤§å°ã€‚è§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨<code>Box</code> æ™ºèƒ½æŒ‡é’ˆï¼Œå°†é€’å½’ç±»å‹â€œåœ¨å †ä¸Šé—´æ¥å­˜å‚¨â€ï¼Œ<code>List</code>æœ¬èº«å°±æœ‰å›ºå®šå¤§å°äº†ã€‚</p>
<pre class="playground"><code class="language-rust editable edition2024">// é€’å½’ enumï¼šå¦‚æœæ²¡æœ‰ Boxï¼Œç¼–è¯‘å™¨æ— æ³•åœ¨ç¼–è¯‘æœŸçŸ¥é“ List çš„å¤§å°ã€‚
// Box&lt;List&gt; è®©é€’å½’â€œåœ¨å †ä¸Šé—´æ¥å­˜å‚¨â€ï¼ŒList æœ¬èº«å°±æœ‰å›ºå®šå¤§å°äº†ã€‚
#[derive(Debug)]
enum List {
    Cons(i32, Box&lt;List&gt;),//Cons å ç”¨ï¼šä¸€ä¸ª i32 çš„ç©ºé—´ + ä¸€ä¸ªæŒ‡é’ˆçš„ç©ºé—´
    Nil,
}
impl List {
    fn new() -&gt; Self {
        List::Nil
    }
    fn prepend(self, v: i32) -&gt; Self {
        List::Cons(v, Box::new(self))
    }
    fn len(&amp;self) -&gt; usize {
        match self {
            List::Cons(_, next) =&gt; 1 + next.len(),
            List::Nil =&gt; 0,
        }
    }
}
fn main() {
    let list = List::new().prepend(3).prepend(2).prepend(1);
    println!("{list:?}");
    println!("len = {}", list.len());
}</code></pre>
<h3 id="ç¤ºä¾‹è¿”å›-trait-objectåŠ¨æ€åˆ†å‘"><a class="header" href="#ç¤ºä¾‹è¿”å›-trait-objectåŠ¨æ€åˆ†å‘">ç¤ºä¾‹ï¼šè¿”å› trait objectï¼ˆåŠ¨æ€åˆ†å‘ï¼‰</a></h3>
<pre class="playground"><code class="language-rust editable edition2024">trait Draw {
    fn draw(&amp;self);
}
struct Circle {r: f32}
impl Draw for Circle {
    fn draw(&amp;self) {
        println!("Circle radius = {}", self.r);
    }
}
struct Square {side: f32}
impl Draw for Square {
    fn draw(&amp;self) {
        println!("Square side = {}", self.side);
    }
}
// è¿”å› Box&lt;dyn Draw&gt;ï¼šè°ƒç”¨è€…åªçŸ¥é“â€œå®ƒèƒ½ drawâ€ï¼Œä¸å…³å¿ƒå…·ä½“ç±»å‹ã€‚
// è¿™ä¼šä½¿ç”¨åŠ¨æ€åˆ†å‘ï¼ˆvtableï¼‰ã€‚
fn make_shape(kind: &amp;str) -&gt; Box&lt;dyn Draw&gt; {
    match kind {
        "circle" =&gt; Box::new(Circle { r: 2.0 }),
        _ =&gt; Box::new(Square { side: 3.0 }),
    }
}
fn main() {
    let s1 = make_shape("circle");
    let s2 = make_shape("square");
    s1.draw();
    s2.draw();
}</code></pre>
<hr>
<h2 id="2-rctå•çº¿ç¨‹å¼•ç”¨è®¡æ•°å…±äº«æ‰€æœ‰æƒ"><a class="header" href="#2-rctå•çº¿ç¨‹å¼•ç”¨è®¡æ•°å…±äº«æ‰€æœ‰æƒ">2. <code>Rc&lt;T&gt;</code>ï¼šå•çº¿ç¨‹å¼•ç”¨è®¡æ•°å…±äº«æ‰€æœ‰æƒ</a></h2>
<p>åœ¨ <code>Rust</code> çš„æ‰€æœ‰æƒè§„åˆ™ä¸­ï¼Œé€šå¸¸ä¸€ä¸ªå€¼åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…ã€‚ä½†åœ¨æŸäº›å¤æ‚çš„åº”ç”¨åœºæ™¯ä¸­ï¼ˆä¾‹å¦‚å›¾ç»“æ„ã€ç¤¾äº¤ç½‘ç»œæˆ–å…±äº«é…ç½®ï¼‰ï¼Œä¸€ä¸ªæ•°æ®å¯èƒ½éœ€è¦è¢«å¤šä¸ªä¸åŒçš„éƒ¨åˆ†å…±åŒæ‹¥æœ‰ã€‚è¿™æ—¶ï¼Œ<code>Box&lt;T&gt;</code> çš„ç‹¬å æ‰€æœ‰æƒå°±ä¸å¤Ÿç”¨äº†ï¼Œæˆ‘ä»¬éœ€è¦ <code>Rc&lt;T&gt;</code>(<code>Reference Counted</code>å¼•ç”¨è®¡æ•°)ã€‚</p>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li><strong>ä¸ºä»€ä¹ˆéœ€è¦ Rc</strong> ï¼šå®ƒå…è®¸ä¸€ä¸ªæ•°æ®æ‹¥æœ‰å¤šä¸ªæ‰€æœ‰è€…ã€‚å®ƒåœ¨å †ä¸Šå­˜å‚¨æ•°æ®ï¼Œå¹¶é¢å¤–è®°å½•ä¸€ä¸ªâ€œå¼•ç”¨è®¡æ•°å™¨â€ï¼Œç”¨æ¥ç»Ÿè®¡ç›®å‰æœ‰å¤šå°‘ä¸ªæŒ‡é’ˆæŒ‡å‘è¿™ä»½æ•°æ®</li>
<li><strong>åªè¯»å…±äº«</strong>ï¼š<code>Rc&lt;T&gt;</code> é»˜è®¤åªå…è®¸ä½ ä¸å¯å˜åœ°å€Ÿç”¨æ•°æ®ã€‚å¦‚æœä½ æƒ³é€šè¿‡å…¶ä¸­ä¸€ä¸ª <code>Rc</code> ä¿®æ”¹æ•°æ®ï¼Œç¼–è¯‘å™¨ä¼šæ‹’ç»ï¼ˆé™¤éé…åˆåé¢è¦è®²çš„ <code>RefCell</code>ï¼‰ã€‚</li>
<li><strong>å…±äº«è€Œéæ‹·è´</strong>ï¼šå½“ä½ â€œå…‹éš†â€ä¸€ä¸ª <code>Rc&lt;T&gt;</code> æ—¶ï¼ŒRust å¹¶ä¸ä¼šåœ¨å †ä¸Šé‡æ–°åˆ†é…å†…å­˜å¹¶æ‹·è´æ•°æ®ï¼Œè€Œæ˜¯
<ul>
<li><strong>å¢åŠ å¼•ç”¨è®¡æ•°</strong>ï¼šè®¡æ•°å™¨åŠ  1ã€‚</li>
<li><strong>æ‹·è´æŒ‡é’ˆåœ°å€</strong>ï¼šåœ¨æ ˆä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå †ä½ç½®ã€‚</li>
<li>åªæœ‰å½“<strong>è®¡æ•°å™¨å½’é›¶</strong>æ—¶: å †ä¸Šçš„æ•°æ®æ‰ä¼šè¢«çœŸæ­£æ¸…ç†ã€‚</li>
</ul>
</li>
<li><strong>å¼ºå¼•ç”¨/å¼±å¼•ç”¨</strong>
<ul>
<li><code>Rc::clone(&amp;rc)</code> å¢åŠ å¼ºå¼•ç”¨è®¡æ•°ï¼ˆä¸æ˜¯æ·±æ‹·è´ï¼‰</li>
<li><code>Weak&lt;T&gt;</code> ç”¨äºæ‰“ç ´ç¯ï¼Œé¿å…å†…å­˜æ³„æ¼</li>
</ul>
</li>
<li><strong>å¾ªç¯å¼•ç”¨é—®é¢˜</strong> ï¼š<code>Rc</code> å½¢æˆç¯ä¼š  <strong>æ³„æ¼</strong> ï¼ˆè®¡æ•°æ°¸è¿œä¸ä¸º 0ï¼‰</li>
<li>å¸¸ç”¨ APIï¼š<code>Rc::new</code>ã€<code>Rc::clone</code>ã€<code>Rc::strong_count</code>ã€<code>Rc::weak_count</code>ã€<code>Rc::downgrade</code></li>
</ul>
<h3 id="ç¤ºä¾‹å…±äº«ä¸€æ®µæ•°æ®"><a class="header" href="#ç¤ºä¾‹å…±äº«ä¸€æ®µæ•°æ®">ç¤ºä¾‹ï¼šå…±äº«ä¸€æ®µæ•°æ®</a></h3>
<pre class="playground"><code class="language-rust editable edition2024">use std::rc::Rc;
fn main() {
    // 1. åœ¨å †ä¸Šåˆ›å»ºå…±äº«æ•°æ®ï¼Œåˆå§‹è®¡æ•°ä¸º 1
    let config = Rc::new(String::from("æ ¸å¿ƒé…ç½®ç¨‹åº"));
    
    println!("--- åˆå§‹çŠ¶æ€ ---");
    println!("å†…å®¹: {}", config);
    println!("å¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;config));

    // 2. å…±äº«æ•°æ®ï¼šåˆ›å»ºä¸¤ä¸ªæ–°çš„æŒ‡é’ˆæŒ‡å‘åŒä¸€å—å †å†…å­˜
    // Rc::clone ä»…å¢åŠ è®¡æ•°ï¼Œä¸ä¼šæ‹·è´å­—ç¬¦ä¸²æ–‡æœ¬
    let user_a = Rc::clone(&amp;config);
    let user_b = Rc::clone(&amp;config);

    println!("\n--- å…±äº«å ---");
    println!("User A çœ‹åˆ°çš„å†…å®¹: {}", user_a);
    println!("User B çœ‹åˆ°çš„å†…å®¹: {}", user_b);
    println!("å½“å‰æ€»å¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;config));

    // 3. é‡Šæ”¾å…¶ä¸­ä¸€ä¸ªå¼•ç”¨
    drop(user_a);
    println!("\n--- é‡Šæ”¾ User A å ---");
    println!("å‰©ä½™å¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;config));
}</code></pre>
<ul>
<li><strong>å†…å­˜ç‰©ç†è¡¨ç°</strong>ï¼š<code>config</code>ã€<code>user_a</code> å’Œ <code>user_b</code> æ˜¯ä¸‰ä¸ªå­˜å‚¨åœ¨æ ˆä¸Šçš„æŒ‡é’ˆï¼Œå®ƒä»¬å†…éƒ¨å­˜å‚¨çš„å†…å­˜åœ°* å€å®Œå…¨ç›¸åŒï¼Œéƒ½æŒ‡å‘å †ä¸Šçš„åŒä¸€ä¸ª <code>String</code>ã€‚</li>
<li><strong>å†…å®¹è®¿é—®</strong>ï¼šç”±äºå®ç°äº† <code>Deref</code> ç‰¹å¾ï¼Œä½ å¯ä»¥åƒä½¿ç”¨æ™®é€š <code>String</code> ä¸€æ ·ç›´æ¥æ‰“å° <code>user_a</code> æˆ– <code>user_b</code>ã€‚</li>
<li><strong>è®¡æ•°å˜åŒ–</strong>ï¼šæ¯æ¬¡è°ƒç”¨ <code>Rc::clone</code>ï¼Œè®¡æ•°å™¨åŠ  1ï¼›æ¯æ¬¡æŒ‡é’ˆç¦»å¼€ä½œç”¨åŸŸï¼ˆæˆ–è¢« <code>drop</code>ï¼‰ï¼Œè®¡æ•°å™¨å‡ 1ã€‚</li>
</ul>
<h3 id="å¼ºå¼•ç”¨-strong-reference-ä¸-å¼±å¼•ç”¨-weak-reference"><a class="header" href="#å¼ºå¼•ç”¨-strong-reference-ä¸-å¼±å¼•ç”¨-weak-reference">å¼ºå¼•ç”¨ (Strong Reference) ä¸ å¼±å¼•ç”¨ (Weak Reference)</a></h3>
<p>è¿™æ˜¯ç®¡ç† <code>Rc</code> ç”Ÿå‘½å‘¨æœŸçš„ä¸¤ç§æ‰‹æ®µï¼š</p>
<ul>
<li>
<p><strong>å¼ºå¼•ç”¨ (<code>Rc&lt;T&gt;</code>)</strong>ï¼š</p>
<ul>
<li><strong>è¡Œä¸º</strong>ï¼šä½¿ç”¨ <code>Rc::clone(&amp;rc)</code> ä¼šå¢åŠ <strong>å¼ºå¼•ç”¨è®¡æ•°</strong>ã€‚</li>
<li><strong>æœ¬è´¨</strong>ï¼šå®ƒä¸æ˜¯æ·±æ‹·è´ï¼ˆDeep Copyï¼‰ï¼Œåªæ˜¯åœ¨æ ˆä¸Šå¤šäº†ä¸€ä¸ªæŒ‡å‘å †å†…å­˜çš„æŒ‡é’ˆï¼Œå¹¶åœ¨å †ä¸ŠæŠŠè®¡æ•°å™¨åŠ  1ã€‚</li>
<li><strong>ä½œç”¨</strong>ï¼šåªè¦å¼ºå¼•ç”¨è®¡æ•°å¤§äº 0ï¼Œå †ä¸Šçš„æ•°æ®å°±<strong>ç»å¯¹ä¸ä¼š</strong>è¢«é”€æ¯ã€‚</li>
</ul>
</li>
<li>
<p><strong>å¼±å¼•ç”¨ (<code>Weak&lt;T&gt;</code>)</strong>ï¼š</p>
<ul>
<li><strong>è¡Œä¸º</strong>ï¼šé€šè¿‡ <code>Rc::downgrade(&amp;rc)</code> åˆ›å»ºã€‚</li>
<li><strong>æœ¬è´¨</strong>ï¼šå®ƒä¼šå¢åŠ <strong>å¼±å¼•ç”¨è®¡æ•°</strong>ï¼Œä½†<strong>ä¸å½±å“</strong>å¼ºå¼•ç”¨è®¡æ•°ã€‚</li>
<li><strong>ä½œç”¨</strong>ï¼šå®ƒä¸æ‹¥æœ‰æ•°æ®çš„æ‰€æœ‰æƒã€‚å³ä¾¿è¿˜æœ‰ 100 ä¸ª <code>Weak</code> æŒ‡é’ˆæŒ‡å‘æ•°æ®ï¼Œåªè¦å¼ºå¼•ç”¨è®¡æ•°å½’é›¶ï¼Œæ•°æ®ä¾ç„¶ä¼šè¢«æ¸…ç†ã€‚</li>
<li><strong>ä½¿ç”¨</strong>ï¼šå› ä¸ºæ•°æ®å¯èƒ½å·²è¢«é”€æ¯ï¼Œä½¿ç”¨å‰å¿…é¡»é€šè¿‡ <code>weak_ptr.upgrade()</code> å°†å…¶â€œå‡çº§â€å› <code>Option&lt;Rc&lt;T&gt;&gt;</code> è¿›è¡Œæ£€æŸ¥ã€‚</li>
</ul>
</li>
</ul>
<pre class="playground"><code class="language-rust editable edition2024">use std::rc::Rc;
fn main() {
    // 1. åˆ›å»ºä¸€ä¸ªå¼ºå¼•ç”¨ Rc
    let strong_ptr = Rc::new(String::from("Rust æ™ºèƒ½æŒ‡é’ˆ"));
    
    // 2. ä»å¼ºå¼•ç”¨åˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨
    // downgrade ä¸ä¼šå¢åŠ  strong_count
    let weak_ptr = Rc::downgrade(&amp;strong_ptr);
    let weak_ptr2 = Rc::downgrade(&amp;strong_ptr);

    println!("--- åˆå§‹çŠ¶æ€ ---");
    println!("å¼ºå¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;strong_ptr)); // 1
    println!("å¼±å¼•ç”¨è®¡æ•°: {}", Rc::weak_count(&amp;strong_ptr));   // 2

    // 3. å°è¯•ä½¿ç”¨å¼±å¼•ç”¨è®¿é—®æ•°æ®
    // å¿…é¡»é€šè¿‡ upgrade() å‡çº§ä¸º Option&lt;Rc&lt;T&gt;&gt;
    match weak_ptr.upgrade() {
        Some(rc) =&gt; println!("å¼±å¼•ç”¨å‡çº§æˆåŠŸï¼Œå¾—åˆ°æ•°æ®: {}", rc),
        None =&gt; println!("å¼±å¼•ç”¨å‡çº§å¤±è´¥ï¼Œæ•°æ®å·²é”€æ¯"),
    }

    // é”€æ¯ä¸€ä¸ªå¼±å¼•ç”¨
    drop(weak_ptr2);
    println!("é”€æ¯ä¸€ä¸ªå¼±å¼•ç”¨åå¼ºå¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;strong_ptr)); // 1
    println!("é”€æ¯ä¸€ä¸ªå¼±å¼•ç”¨åå¼±å¼•ç”¨è®¡æ•°: {}", Rc::weak_count(&amp;strong_ptr));   // 1

    println!("\n--- é”€æ¯å¼ºå¼•ç”¨å ---");
    // 4. æ‰‹åŠ¨é”€æ¯å¼ºå¼•ç”¨ï¼ˆæ¨¡æ‹Ÿç¦»å¼€ä½œç”¨åŸŸï¼‰
    drop(strong_ptr);

    // 5. å†æ¬¡å°è¯•ä½¿ç”¨å¼±å¼•ç”¨è®¿é—®æ•°æ®
    // æ­¤æ—¶å¼ºå¼•ç”¨è®¡æ•°ä¸º 0ï¼Œæ•°æ®å·²è¢«å›æ”¶
    match weak_ptr.upgrade() {
        Some(rc) =&gt; println!("å¼±å¼•ç”¨å‡çº§æˆåŠŸ: {}", rc),
        None =&gt; println!("å¼±å¼•ç”¨å‡çº§å¤±è´¥ï¼Œæ•°æ®å·²é”€æ¯"),
    }
}</code></pre>
<h3 id="rc-ç¯"><a class="header" href="#rc-ç¯">Rc ç¯</a></h3>
<p><strong>å¾ªç¯å¼•ç”¨é—®é¢˜</strong>:è¿™æ˜¯<code>Rc</code> æœ€å±é™©çš„é™·é˜±ã€‚</p>
<ul>
<li><strong>æˆå› </strong>ï¼šå¦‚æœä¸¤ä¸ª <code>Rc</code> æŒ‡é’ˆäº’ç›¸æŒ‡å‘å¯¹æ–¹ï¼ˆä¾‹å¦‚ï¼šèŠ‚ç‚¹ A æ‹¥æœ‰æŒ‡å‘èŠ‚ç‚¹ B çš„ Rcï¼Œè€ŒèŠ‚ç‚¹ B ä¹Ÿæ‹¥æœ‰æŒ‡å‘èŠ‚ç‚¹ A çš„ Rcï¼‰ï¼Œå°±ä¼šå½¢æˆä¸€ä¸ªç¯ã€‚</li>
<li><strong>åæœ</strong>ï¼šç”±äºç¯çš„å­˜åœ¨ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡çš„å¼ºå¼•ç”¨è®¡æ•°æ°¸è¿œè‡³å°‘ä¸º 1ã€‚å½“å¤–éƒ¨ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œå®ƒä»¬æ— æ³•è¢«æ¸…ç†ï¼Œå¯¼è‡´<strong>å†…å­˜æ³„æ¼</strong>ï¼ˆ<code>Memory Leak</code>ï¼‰ã€‚</li>
<li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå°†å…¶ä¸­ä¸€æ¡è·¯å¾„æ”¹ä¸º <code>Weak&lt;T&gt;</code>ã€‚ä¾‹å¦‚ï¼šçˆ¶èŠ‚ç‚¹ç”¨ <code>Rc</code> æŒ‡å‘å­èŠ‚ç‚¹ï¼ˆå¼ºå¼•ç”¨ï¼‰ï¼Œè€Œå­èŠ‚ç‚¹ç”¨ <code>Weak</code> æŒ‡å‘çˆ¶èŠ‚ç‚¹ï¼ˆå¼±å¼•ç”¨ï¼‰ã€‚è¿™æ ·ç¯å°±è¢«æ‰“ç ´äº†ã€‚</li>
</ul>
<p>ç”±äº <code>Rc&lt;T&gt;</code> é»˜è®¤æ˜¯åªè¯»çš„ï¼Œä¸ºäº†åœ¨åˆ›å»ºèŠ‚ç‚¹åèƒ½ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘å¯¹æ–¹ï¼Œæˆ‘ä»¬éœ€è¦é…åˆä½¿ç”¨ <code>RefCell&lt;T&gt;</code>æ¼”ç¤ºç¯å½¢å¼•ç”¨ã€‚</p>
<pre class="playground"><code class="language-rust editable edition2024">use std::rc::Rc;
use std::cell::RefCell;
// å®šä¹‰ä¸€ä¸ªç®€å•çš„ Nodeï¼Œå®ƒå¯ä»¥æŒ‡å‘å¦ä¸€ä¸ª Node
#[derive(Debug)]
struct Node {
    next: RefCell&lt;Option&lt;Rc&lt;Node&gt;&gt;&gt;,
}
impl Drop for Node {
    fn drop(&amp;mut self) {
        println!("Node è¢«é”€æ¯äº†ï¼");
    }
}
fn main() {
    // 1. åˆ›å»ºä¸¤ä¸ªèŠ‚ç‚¹ A å’Œ B
    let a = Rc::new(Node { next: RefCell::new(None) });
    let b = Rc::new(Node { next: RefCell::new(None) });

    println!("--- å»ºç«‹ç¯ä¹‹å‰ ---");
    println!("A çš„å¼ºå¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;a)); // 1
    println!("B çš„å¼ºå¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;b)); // 1

    // 2. å»ºç«‹ç¯ï¼šA æŒ‡å‘ Bï¼ŒB æŒ‡å‘ A
    *a.next.borrow_mut() = Some(Rc::clone(&amp;b));
    *b.next.borrow_mut() = Some(Rc::clone(&amp;a));

    println!("--- å»ºç«‹ç¯ä¹‹å ---");
    println!("A çš„å¼ºå¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;a)); // 2
    println!("B çš„å¼ºå¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&amp;b)); // 2

    // 3. å‡½æ•°ç»“æŸå‰ï¼Œæˆ‘ä»¬å°è¯•è®© a å’Œ b ç¦»å¼€ä½œç”¨åŸŸ
    println!("--- main å‡½æ•°å³å°†ç»“æŸ ---");
} 
// æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™é‡Œåº”è¯¥æ‰“å°ä¸¤æ¬¡ "Node è¢«é”€æ¯äº†ï¼"ï¼Œä½†å®é™…ä¸Šä»€ä¹ˆéƒ½ä¸ä¼šæ‰“å°ã€‚</code></pre>
<blockquote>
<p>ç¬”è®°ï¼šä¸ºä»€ä¹ˆä¼šæ³„æ¼ï¼Ÿ</p>
</blockquote>
<ul>
<li><strong>è®¡æ•°å™¨é€»è¾‘</strong>ï¼šå½“ main å‡½æ•°ç»“æŸæ—¶ï¼Œå˜é‡ a å’Œ b è¢«ä¸¢å¼ƒã€‚
<ul>
<li><strong>a è¢«ä¸¢å¼ƒ</strong>ï¼Œå…¶å¯¹åº”çš„å †å†…å­˜è®¡æ•°ä» 2 é™åˆ° 1ã€‚</li>
<li><strong>b è¢«ä¸¢å¼ƒ</strong>ï¼Œå…¶å¯¹åº”çš„å †å†…å­˜è®¡æ•°ä» 2 é™åˆ° 1ã€‚</li>
</ul>
</li>
<li><strong>æ­»å¾ªç¯</strong>ï¼šå †å†…å­˜ A è¿˜åœ¨ç­‰å¾…å †å†…å­˜ B é‡Šæ”¾ä»¥ä¾¿å°†å…¶è®¡æ•°å‡ä¸º 0ï¼›è€Œå †å†…å­˜ B ä¹Ÿåœ¨ç­‰å¾…å †å†…å­˜ A é‡Šæ”¾ã€‚</li>
<li><strong>ç»“æœ</strong>ï¼šä¸¤ä¸ªå†…å­˜å—çš„è®¡æ•°å™¨æ°¸è¿œå¡åœ¨ 1ï¼Œdrop æ–¹æ³•æ°¸è¿œä¸ä¼šè¢«è§¦å‘ï¼Œè¿™å—å †å†…å­˜å°±æ³„æ¼äº†ã€‚</li>
</ul>
<h4 id="è§£å†³æ–¹æ¡ˆ"><a class="header" href="#è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</a></h4>
<pre class="playground"><code class="language-rust editable edition2024">use std::cell::RefCell;
use std::rc::{Rc, Weak};

// ä¸€ä¸ªâ€œçˆ¶-å­â€èŠ‚ç‚¹ç»“æ„ï¼š
// - å­èŠ‚ç‚¹ç”¨ Rc æ‹¥æœ‰ï¼ˆå¤šä¸ªåœ°æ–¹å¯ä»¥å…±äº«å­©å­ï¼‰
// - çˆ¶æŒ‡é’ˆç”¨ Weak æŒ‡å‘çˆ¶ï¼ˆé¿å…å½¢æˆ Rc ç¯ï¼‰
#[derive(Debug)]
struct Node {
    value: i32,
    parent: RefCell&lt;Weak&lt;Node&gt;&gt;,  // Weak&lt;Node&gt;ï¼šè¿™æ˜¯æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„æŒ‡é’ˆ, Weak ä¸å¢åŠ å¼ºå¼•ç”¨è®¡æ•°
    children: RefCell&lt;Vec&lt;Rc&lt;Node&gt;&gt;&gt;,    // children æ‹¥æœ‰å­èŠ‚ç‚¹
}
impl Drop for Node {
    fn drop(&amp;mut self) {
        println!("Node è¢«é”€æ¯äº†ï¼");
    }
}
fn main() {
    let parent = Rc::new(Node {
        value: 1,
        parent: RefCell::new(Weak::new()),// åˆå§‹åŒ–æ—¶ï¼Œçˆ¶èŠ‚ç‚¹æ²¡æœ‰â€œçˆ¶â€ï¼Œè®¾ä¸ºç©ºå¼±å¼•ç”¨
        children: RefCell::new(vec![]),// åˆå§‹åŒ–æ—¶ï¼Œå­èŠ‚ç‚¹åˆ—è¡¨ä¸ºç©ºå‘é‡
    });//å°† Node å®ä¾‹æ”¾å…¥å †ä¸­ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œæ­¤æ—¶ parent çš„å¼ºå¼•ç”¨è®¡æ•°ä¸º 1ï¼Œå¼±è®¡æ•° = 0

    let child = Rc::new(Node {
        value: 2,
        parent: RefCell::new(Weak::new()),
        children: RefCell::new(vec![]),
    });//child çš„å¼ºè®¡æ•° = 1ï¼Œå¼±è®¡æ•° = 0

    // å»ºç«‹çˆ¶ -&gt; å­ çš„å¼ºå¼•ç”¨å…³ç³»
    parent.children.borrow_mut().push(Rc::clone(&amp;child));
    // é€šè¿‡ borrow_mut() è·å– Vec çš„å¯å˜å€Ÿç”¨ï¼Œç„¶åæŠŠ child çš„ä¸€ä¸ªå…‹éš†å­˜è¿›å»ã€‚
    // æ­¤æ—¶ child çš„å¼ºå¼•ç”¨è®¡æ•°å˜ä¸º 2ï¼ˆä¸€ä¸ªæ˜¯å˜é‡ childï¼Œä¸€ä¸ªæ˜¯ parent.children é‡Œçš„å…‹éš†ï¼‰

    // å»ºç«‹å­ -&gt; çˆ¶ çš„å¼±å¼•ç”¨å…³ç³»ï¼ˆå…³é”®ï¼šé¿å…ç¯ï¼‰
    *child.parent.borrow_mut() = Rc::downgrade(&amp;parent);
    //é€šè¿‡ Rc::downgrade å°† parent çš„å¼ºå¼•ç”¨è½¬ä¸ºå¼±å¼•ç”¨å¹¶å­˜å…¥ child.parent
    //parent çš„å¼ºè®¡æ•°ä¿æŒä¸º 1ã€‚parent çš„å¼±è®¡æ•°å˜ä¸º 1ã€‚

    println!("parent strong = {}, weak = {}",
        Rc::strong_count(&amp;parent),
        Rc::weak_count(&amp;parent)
    );
    println!("child strong = {}, weak = {}",
        Rc::strong_count(&amp;child),
        Rc::weak_count(&amp;child)
    );

    // Weak::upgradeï¼šå°è¯•æŠŠ Weak å˜å› Rcï¼ˆå¦‚æœçˆ¶èŠ‚ç‚¹å·²é‡Šæ”¾åˆ™è¿”å› Noneï¼‰
    if let Some(p) = child.parent.borrow().upgrade() {
        println!("child's parent value = {}", p.value);
    } else {
        println!("parent already dropped");
    }
}
</code></pre>
<blockquote>
<p>æ ¸å¿ƒè®¾è®¡ï¼šä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ç»“æ„ï¼Ÿ</p>
</blockquote>
<p>åœ¨ Rust ä¸­ï¼ŒæŒ‡é’ˆæ˜¯è¡¨ç¤ºå†…å­˜åœ°å€çš„ç±»å‹ã€‚ä¸ºäº†å®ç°çˆ¶å­åŒå‘é“¾æ¥ï¼Œä»£ç é‡‡ç”¨äº†â€œå¼ºå¼±ç»“åˆâ€çš„ç­–ç•¥ï¼š</p>
<ul>
<li><code>children: RefCell&lt;Vec&lt;Rc&lt;Node&gt;&gt;&gt;</code>(å‘ä¸‹å¼ºå¼•ç”¨)ï¼š
<ul>
<li>çˆ¶èŠ‚ç‚¹éœ€è¦â€œæ‹¥æœ‰â€å®ƒçš„å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>Rc&lt;Node&gt;</code>ã€‚åªè¦çˆ¶èŠ‚ç‚¹å­˜åœ¨ï¼Œå­èŠ‚ç‚¹å°±ä¸ä¼šè¢«é”€æ¯ã€‚</li>
</ul>
</li>
<li><code>parent: RefCell&lt;Weak&lt;Node&gt;&gt;</code> (å‘ä¸Šå¼±å¼•ç”¨)ï¼š
<ul>
<li>è¿™æ˜¯ç ´ç¯å…³é”®ã€‚å­èŠ‚ç‚¹åªéœ€è¦â€œçŸ¥é“â€çˆ¶èŠ‚ç‚¹æ˜¯è°ï¼Œä½†ä¸åº”è¯¥â€œæ‹¥æœ‰â€çˆ¶èŠ‚ç‚¹ã€‚</li>
<li>ä½¿ç”¨ <code>Weak&lt;Node&gt;</code> ä¸ä¼šå¢åŠ çˆ¶èŠ‚ç‚¹çš„å¼ºå¼•ç”¨è®¡æ•°ï¼Œå› æ­¤ä¸ä¼šé˜»æ­¢çˆ¶èŠ‚ç‚¹è¢«å›æ”¶ã€‚</li>
</ul>
</li>
<li><code>RefCell</code>(å†…éƒ¨å¯å˜æ€§)ï¼š
<ul>
<li>å› ä¸ºèŠ‚ç‚¹åˆ›å»ºæ—¶æ˜¯å­¤ç«‹çš„ï¼Œå¿…é¡»åœ¨åˆ›å»ºåä¿®æ”¹å±æ€§ï¼ˆå»ºç«‹è¿æ¥ï¼‰ï¼Œæ‰€ä»¥éœ€è¦ RefCell ç»•è¿‡ç¼–è¯‘æœŸçš„ä¸å¯å˜æ£€æŸ¥ã€‚</li>
</ul>
</li>
</ul>
<div class="table-wrapper">
<table>
<thead>
<tr><th>æ‰§è¡Œé˜¶æ®µ</th><th>Parent è®¡æ•° (Strong/Weak)</th><th>Child è®¡æ•° (Strong/Weak)</th><th>é€»è¾‘è¯´æ˜</th></tr>
</thead>
<tbody>
<tr><td>åˆ›å»ºå</td><td>1 / 0</td><td>1 / 0</td><td>å˜é‡ parent å’Œ child å„è‡ªæ‹¥æœ‰ 1 ä¸ªæ‰€æœ‰æƒ</td></tr>
<tr><td>å»ºç«‹çˆ¶-&gt;å­è¿æ¥</td><td>1 / 0</td><td>2 / 0</td><td>parent.children å­˜äº†ä¸€ä¸ª Rc::clone(&amp;child)ï¼Œå¼ºè®¡æ•°åŠ  1</td></tr>
<tr><td>å»ºç«‹å­-&gt;çˆ¶è¿æ¥</td><td>1 / 1</td><td>2 / 0</td><td>child.parent å­˜äº†ä¸€ä¸ª downgrade(&amp;parent)ï¼Œä»…å¢åŠ å¼±è®¡æ•°</td></tr>
</tbody>
</table>
</div>
<h3 id="å¸¸ç”¨-api-é€ŸæŸ¥è¡¨"><a class="header" href="#å¸¸ç”¨-api-é€ŸæŸ¥è¡¨">å¸¸ç”¨ API é€ŸæŸ¥è¡¨</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>API</th><th>åŠŸèƒ½æè¿°</th></tr>
</thead>
<tbody>
<tr><td><code>Rc::new(val)</code></td><td>åˆ›å»ºä¸€ä¸ªæ–°çš„ Rc å®ä¾‹ï¼Œåˆå§‹å¼ºè®¡æ•°ä¸º 1ã€‚</td></tr>
<tr><td><code>Rc::clone(&amp;rc)</code></td><td>å¢åŠ å¼ºå¼•ç”¨è®¡æ•°ï¼Œè¿”å›æ–°æŒ‡é’ˆã€‚</td></tr>
<tr><td><code>Rc::strong_count(&amp;rc)</code></td><td>æŸ¥çœ‹å½“å‰çš„å¼ºå¼•ç”¨æ•°é‡ã€‚</td></tr>
<tr><td><code>Rc::weak_count(&amp;rc)</code></td><td>æŸ¥çœ‹å½“å‰çš„å¼±å¼•ç”¨æ•°é‡ã€‚</td></tr>
<tr><td><code>Rc::downgrade(&amp;rc)</code></td><td>è·å–ä¸€ä¸ª <code>Weak&lt;T&gt;</code> æŒ‡é’ˆã€‚</td></tr>
<tr><td><code>weak.upgrade()</code></td><td>å°è¯•å°†å¼±å¼•ç”¨è½¬å›å¼ºå¼•ç”¨ï¼Œè¿”å› <code>Option&lt;Rc&lt;T&gt;&gt;</code>ã€‚</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="3-arctå¤šçº¿ç¨‹å¼•ç”¨è®¡æ•°å…±äº«æ‰€æœ‰æƒ"><a class="header" href="#3-arctå¤šçº¿ç¨‹å¼•ç”¨è®¡æ•°å…±äº«æ‰€æœ‰æƒ">3. <code>Arc&lt;T&gt;</code>ï¼šå¤šçº¿ç¨‹å¼•ç”¨è®¡æ•°å…±äº«æ‰€æœ‰æƒ</a></h2>
<p>å¦‚æœåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ <code>Rc&lt;T&gt;</code>ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥æŠ¥é”™ï¼Œå› ä¸º <code>Rc&lt;T&gt;</code> å†…éƒ¨çš„å¼•ç”¨è®¡æ•°æ˜¯éåŸå­çš„ï¼Œæ— æ³•åœ¨å¤šä¸ªçº¿ç¨‹é—´å®‰å…¨åœ°æ›´æ–°ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>Rust</code> æä¾›äº† <code>Arc&lt;T&gt;</code>ï¼ˆ<code>Atomic Reference Counted</code> åŸå­å¼•ç”¨è®¡æ•°ï¼‰,å®ƒå…è®¸åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å®‰å…¨åœ°å…±äº«åŒä¸€ä¸ªå †æ•°æ®çš„æ‰€æœ‰æƒã€‚å’Œ <code>Rc&lt;T&gt;</code> ä¸€æ ·ï¼Œ<code>Arc&lt;T&gt;</code> é»˜è®¤ä¹Ÿæ˜¯åªè¯»çš„ã€‚å¦‚æœä½ éœ€è¦å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹æ•°æ®ï¼Œä½ è¿˜éœ€è¦é…åˆä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬è¦è®²çš„é”æœºåˆ¶ï¼ˆå¦‚ Mutexï¼‰ã€‚</p>
<p>åœ¨è®¡ç®—æœºä¸­ï¼Œæ™®é€šçš„æ•´æ•°åŠ å‡ï¼ˆå¦‚ <code>count += 1</code>ï¼‰å¹¶ä¸æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ“ä½œã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å°è¯•ä¿®æ”¹ <code>Rc</code> çš„è®¡æ•°å™¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´è®¡æ•°é”™è¯¯ï¼Œè¿›è€Œå¼•å‘æå‰é‡Šæ”¾å†…å­˜æˆ–å†…å­˜æ³„æ¼ã€‚<code>Arc&lt;T&gt;</code> ä½¿ç”¨äº† åŸå­æ“ä½œæ¥æ›´æ–°è®¡æ•°ã€‚è¿™æ˜¯ä¸€ç§ç¡¬ä»¶å±‚é¢çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œèƒ½ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç«äº‰æ—¶è®¡æ•°å™¨ä¾ç„¶å‡†ç¡®ã€‚</p>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li><code>Arc</code> = Atomic Rcï¼ˆçº¿ç¨‹å®‰å…¨ï¼Œè®¡æ•°æ“ä½œæ˜¯åŸå­çš„ï¼‰</li>
<li>æˆæœ¬ï¼šæ¯” <code>Rc</code> æ›´è´µï¼ˆåŸå­æ“ä½œï¼‰ï¼Œå•çº¿ç¨‹åœºæ™¯ä¼˜å…ˆ <code>Rc</code>ä»¥è·å¾—æœ€ä½³æ€§èƒ½</li>
<li>å¸¸è§ç»„åˆï¼š<code>Arc&lt;Mutex&lt;T&gt;&gt;</code>ã€<code>Arc&lt;RwLock&lt;T&gt;&gt;</code></li>
<li>çº¿ç¨‹å®‰å…¨æ ‡å¿—ï¼š
<ul>
<li><strong><code>Rc&lt;T&gt;</code></strong> æœªå®ç° <code>Send</code> å’Œ <code>Sync</code> ç‰¹å¾ï¼Œå› æ­¤ä¸èƒ½è·¨çº¿ç¨‹ä¼ é€’</li>
<li><strong><code>Arc&lt;T&gt;</code></strong> å®ç°äº† <code>Send</code> å’Œ <code>Sync</code>ï¼ˆå‰ææ˜¯å†…éƒ¨çš„ <code>T</code> ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼‰ï¼Œå¯ä»¥åœ¨çº¿ç¨‹é—´è‡ªç”±ç©¿æ¢­</li>
</ul>
</li>
</ul>
<h3 id="ç¤ºä¾‹å¤šçº¿ç¨‹å…±äº«åªè¯»"><a class="header" href="#ç¤ºä¾‹å¤šçº¿ç¨‹å…±äº«åªè¯»">ç¤ºä¾‹ï¼šå¤šçº¿ç¨‹å…±äº«åªè¯»</a></h3>
<pre class="playground"><code class="language-rust editable edition2024">use std::sync::Arc;
use std::thread;
fn main() {
    // 1. åˆ›å»ºä¸€ä¸ª Arc æŒ‡é’ˆ
    let data = Arc::new(String::from("å¤šçº¿ç¨‹å…±äº«æ•°æ®"));
    println!("Arc-data åˆå§‹è®¡æ•°: {}", Arc::strong_count(&amp;data));
    let mut handles = vec![];
    for i in 0..5 {
        // 2. å…‹éš† Arc æŒ‡é’ˆï¼šè¿™åªæ˜¯å¢åŠ åŸå­è®¡æ•°ï¼Œä¸æ‹·è´å­—ç¬¦ä¸²æœ¬èº«
        let data_clone = Arc::clone(&amp;data);
        let handle = thread::spawn(move || {
            // 3. åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨æ•°æ®
            println!("çº¿ç¨‹ {} çœ‹åˆ°çš„æ•°æ®: {}", i, data_clone);
        });
        handles.push(handle);
    }
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    for handle in handles {
        handle.join().unwrap();
    }
    println!("æ‰€æœ‰çº¿ç¨‹å·²å®Œæˆï¼Œæœ€åè®¡æ•°: {}", Arc::strong_count(&amp;data));
}</code></pre>
<hr>
<h2 id="4-çº¿ç¨‹å®‰å…¨å†…éƒ¨å¯å˜æ€§mutext--rwlockt"><a class="header" href="#4-çº¿ç¨‹å®‰å…¨å†…éƒ¨å¯å˜æ€§mutext--rwlockt">4. çº¿ç¨‹å®‰å…¨å†…éƒ¨å¯å˜æ€§ï¼š<code>Mutex&lt;T&gt;</code> / <code>RwLock&lt;T&gt;</code></a></h2>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå•é  <code>Arc&lt;T&gt;</code> åªèƒ½è§£å†³â€œè°æ‹¥æœ‰æ•°æ®â€çš„é—®é¢˜ï¼Œä½†ç”±äº <code>Arc&lt;T&gt;</code> æä¾›çš„å¼•ç”¨æ˜¯ä¸å¯å˜çš„ï¼Œæˆ‘ä»¬æ— æ³•ä¿®æ”¹æ•°æ®ã€‚ä¸ºäº†åœ¨å¤šçº¿ç¨‹ä¸­ä¿®æ”¹æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨â€œ<strong>é”</strong>â€ã€‚</p>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li><code>Mutex&lt;T&gt;</code>ï¼šäº’æ–¥é”ï¼Œæä¾›ç‹¬å å¯å˜è®¿é—®ï¼ˆé”å®ˆå« <code>MutexGuard</code>ï¼‰</li>
<li><code>RwLock&lt;T&gt;</code>ï¼šè¯»å†™é”ï¼Œå¤šè¯»å•å†™</li>
<li><strong>æ­»é”ã€é”ç²’åº¦ã€æŒé”æ—¶é—´</strong> ï¼ˆå·¥ç¨‹ä¸Šå¾ˆå…³é”®ï¼‰</li>
<li>å¸¸è§ç»„åˆï¼š<code>Arc&lt;Mutex&lt;T&gt;&gt;</code>ã€<code>Arc&lt;RwLock&lt;T&gt;&gt;</code></li>
<li>è¿è¡Œæ—¶æˆæœ¬ï¼šåŠ é”/è§£é”ã€ç«äº‰ã€å¯èƒ½é˜»å¡</li>
</ul>
<h3 id="ç¤ºä¾‹mutext-äº’æ–¥é”"><a class="header" href="#ç¤ºä¾‹mutext-äº’æ–¥é”">ç¤ºä¾‹ï¼š<code>Mutex&lt;T&gt;</code> (äº’æ–¥é”)</a></h3>
<p><code>Mutex</code> æ˜¯ <code>Mutual Exclusion</code>ï¼ˆäº’æ–¥ï¼‰çš„ç¼©å†™ã€‚å®ƒä¿è¯åœ¨ä»»ä½•æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®æ•°æ®ã€‚</p>
<p>å·¥ä½œæœºåˆ¶ï¼š</p>
<ol>
<li>çº¿ç¨‹å°è¯•é€šè¿‡ <code>.lock()</code> è·å–é”ã€‚</li>
<li>å¦‚æœé”å·²è¢«å ç”¨ï¼Œçº¿ç¨‹ä¼šé˜»å¡ï¼ˆç­‰å¾…ï¼‰ã€‚</li>
<li>è·å–æˆåŠŸåï¼Œè¿”å›ä¸€ä¸ª <code>MutexGuard</code>ï¼ˆæ™ºèƒ½æŒ‡é’ˆï¼‰ã€‚</li>
<li><strong>è‡ªåŠ¨é‡Šæ”¾</strong>ï¼šç”±äº <code>MutexGuard</code> å®ç°äº† <code>Drop</code> ç‰¹å¾ï¼Œå½“å®ƒç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œé”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œæ— éœ€æ‰‹åŠ¨è§£é”ã€‚</li>
</ol>
<pre class="playground"><code class="language-rust editable edition2024">use std::sync::Mutex;
fn main() {
    let m = Mutex::new(5);
    {
        // lock() è¿”å›ä¸€ä¸ª Resultï¼Œå› ä¸ºå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”æ—¶ panicï¼Œé”ä¼šå˜å¾—â€œä¸­æ¯’â€
        let mut num = m.lock().unwrap(); 
        *num = 6; // é€šè¿‡è§£å¼•ç”¨ä¿®æ”¹å†…éƒ¨æ•°æ®
    } // num ç¦»å¼€ä½œç”¨åŸŸï¼Œé”è‡ªåŠ¨é‡Šæ”¾

    println!("m = {:?}", m);
}</code></pre>
<h3 id="ç¤ºä¾‹rwlockt-è¯»å†™é”"><a class="header" href="#ç¤ºä¾‹rwlockt-è¯»å†™é”">ç¤ºä¾‹ï¼š<code>RwLock&lt;T&gt;</code> (è¯»å†™é”)</a></h3>
<p>RwLock ä»£è¡¨ <code>Read-Write Lock</code>ã€‚å®ƒæ¯” Mutex æ›´çµæ´»ï¼Œéµå¾ªâ€œå¤šè¯»å•å†™â€è§„åˆ™ï¼š</p>
<ul>
<li><strong>å¤šè¯»</strong>ï¼šå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰åª<strong>è¯»é”</strong> (<code>.read()</code>)ã€‚</li>
<li><strong>å•å†™</strong>ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰<strong>å†™é”</strong> (<code>.write()</code>)ã€‚æ­¤æ—¶<strong>ä¸å…è®¸ä»»ä½•è¯»é”</strong>ã€‚</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äºâ€œ<strong>è¯»å¤šå†™å°‘</strong>â€çš„åœºæ™¯ï¼Œæ€§èƒ½é€šå¸¸ä¼˜äº <code>Mutex</code>ã€‚</p>
<p><code>Mutex&lt;T&gt;</code> çš„è§„åˆ™å¾ˆç®€å•ï¼šä»»ä½•äººè¦ç”¨ï¼Œå¿…é¡»æ’é˜Ÿã€‚
è€Œ <code>RwLock&lt;T&gt;</code> å¼•å…¥äº†â€œå¤šè¯»â€é€»è¾‘ï¼Œè¿™è™½ç„¶æé«˜äº†å¹¶å‘æ•ˆç‡ï¼Œä½†ä¹Ÿè®©é€»è¾‘å˜å¾—å¤æ‚ï¼šä½ ä¸èƒ½ç›´æ¥æŠŠä¸€ä¸ªè¯»é”â€œå‡çº§â€ä¸ºå†™é”ã€‚ä½ å¿…é¡»å…ˆé‡Šæ”¾è¯»é”ï¼Œç„¶åå†å»ç«äº‰å†™é”</p>
<pre class="playground"><code class="language-rust editable edition2024">use std::sync::{Arc, RwLock};
use std::thread;
use std::time::Duration;
fn main() {
    // 1. ä½¿ç”¨ Arc åŒ…è£… RwLockï¼Œå®ç°å¤šçº¿ç¨‹å…±äº«æ‰€æœ‰æƒ
    let lock = Arc::new(RwLock::new(5));
    let mut handles = vec![];
    // --- æ¨¡æ‹Ÿå¤šä¸ªè¯»å–è€… ---
    for i in 0..3 {
        let lock_clone = Arc::clone(&amp;lock);
        let handle = thread::spawn(move || {
            // è·å–è¯»é”ï¼šå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥æ­¤å¤„
            let r = lock_clone.read().unwrap();
            println!("è¯»è€… {} è¯»å–åˆ°çš„å€¼: {}", i, *r);
            // è¯»é”åœ¨è¿™é‡Œè‡ªåŠ¨é‡Šæ”¾
        });
        handles.push(handle);
    }
    // --- æ¨¡æ‹Ÿä¸€ä¸ªå†™å…¥è€… ---
    {
        let lock_clone = Arc::clone(&amp;lock);
        let handle = thread::spawn(move || {
            println!("å†™å…¥è€…æ­£åœ¨å°è¯•è·å–å†™é”...");
            // è·å–å†™é”ï¼šæ­¤æ—¶æ‰€æœ‰è¯»é”å’Œå…¶ä»–å†™é”éƒ½ä¼šè¢«é˜»å¡
            let mut w = lock_clone.write().unwrap();
            *w += 10;
            println!("å†™å…¥è€…å·²å°†å€¼ä¿®æ”¹ä¸º: {}", *w);
            // å†™é”åœ¨è¿™é‡Œè‡ªåŠ¨é‡Šæ”¾
        });
        handles.push(handle);
    }
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    for handle in handles {
        handle.join().unwrap();
    }

    println!("æœ€ç»ˆç»“æœ: {}", *lock.read().unwrap());
}</code></pre>
<h4 id="å…³é”®ç»†èŠ‚è§£æ"><a class="header" href="#å…³é”®ç»†èŠ‚è§£æ">å…³é”®ç»†èŠ‚è§£æ</a></h4>
<ul>
<li>
<p><strong><code>.read().unwrap()</code></strong>ï¼š</p>
<ul>
<li>è¿”å›ä¸€ä¸ª <code>ReadGuard</code>ã€‚åªè¦è¿™ä¸ª guard å­˜åœ¨ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿå¯ä»¥è°ƒç”¨ <code>.read()</code> è·å–è¯»é”ã€‚</li>
<li><strong>é™åˆ¶</strong>ï¼šä¸€æ—¦æœ‰äººæŒæœ‰è¯»é”ï¼Œä»»ä½•å°è¯•è°ƒç”¨ <code>.write()</code> çš„çº¿ç¨‹éƒ½ä¼šè¿›å…¥ç¡çœ ç­‰å¾…çŠ¶æ€ã€‚</li>
</ul>
</li>
<li>
<p><strong><code>.write().unwrap()</code></strong>ï¼š</p>
<ul>
<li>è¿”å›ä¸€ä¸ª <code>WriteGuard</code>ã€‚</li>
<li><strong>æ’ä»–æ€§</strong>ï¼šåªæœ‰å½“æ²¡æœ‰ä»»ä½•äººæŒæœ‰è¯»é”ä¸”æ²¡æœ‰ä»»ä½•äººæŒæœ‰å†™é”æ—¶ï¼Œå®ƒæ‰èƒ½æˆåŠŸè·å–ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ­»é”é£é™©</strong>ï¼š</p>
<ul>
<li>å¦‚æœåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œä½ å·²ç»æŒæœ‰äº†è¯»é”ï¼Œåˆå°è¯•å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´<strong>æ­»é”</strong>ã€‚</li>
<li>åœ¨å†™æ“ä½œé¢‘ç¹çš„åœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°â€œè¯»è€…é¥¥é¥¿â€ã€‚</li>
</ul>
</li>
</ul>
<h3 id="æ€»ç»“å¯¹æ¯”mutex-vs-rwlock"><a class="header" href="#æ€»ç»“å¯¹æ¯”mutex-vs-rwlock">æ€»ç»“å¯¹æ¯”ï¼š<code>Mutex</code> vs <code>RwLock</code></a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>ç‰¹æ€§</th><th><code>Mutex&lt;T&gt;</code></th><th><code>RwLock&lt;T&gt;</code></th></tr>
</thead>
<tbody>
<tr><td>è®¿é—®è§„åˆ™</td><td>ä¸€æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è®¿é—®,</td><td>å¤šä¸ªè¯»è€… OR ä¸€ä¸ªå†™è€…</td></tr>
<tr><td>å†…éƒ¨å¯å˜æ€§</td><td>æ˜¯ï¼ˆé€šè¿‡é”è·å–å¯å˜å¼•ç”¨ï¼‰</td><td>æ˜¯ï¼ˆé€šè¿‡å†™é”è·å–å¯å˜å¼•ç”¨ï¼‰</td></tr>
<tr><td>çº¿ç¨‹å®‰å…¨</td><td>æ˜¯</td><td>æ˜¯</td></tr>
<tr><td>æ€§èƒ½</td><td>ç®€å•ã€å¼€é”€å›ºå®š</td><td>è¯»æ“ä½œå¤šæ—¶æ€§èƒ½æ›´å¥½ï¼Œç®¡ç†æˆæœ¬ç•¥é«˜</td></tr>
</tbody>
</table>
</div>
<blockquote>
<p>ğŸ’¡ ç¬”è®°è¦ç‚¹ï¼šä¸ºä»€ä¹ˆå®ƒä»¬ä¹Ÿå«â€œå†…éƒ¨å¯å˜æ€§â€ï¼Ÿ</p>
</blockquote>
<p>å› ä¸ºå³ä½¿ä½ åªæœ‰ä¸€ä¸ªæŒ‡å‘ <code>Mutex&lt;T&gt;</code> çš„ä¸å¯å˜å¼•ç”¨ <code>&amp;Mutex&lt;T&gt;</code>ï¼Œä½ ä¾ç„¶å¯ä»¥é€šè¿‡è°ƒç”¨ <code>.lock()</code> æ–¹æ³•æ¥ä¿®æ”¹å…¶å†…éƒ¨åŒ…è£¹çš„æ•°æ®ã€‚è¿™ç§â€œ<strong>å¤–è¡¨ä¸å¯å˜ï¼Œå†…éƒ¨å¯å˜</strong>â€çš„ç‰¹æ€§æ­£æ˜¯å®ƒä»¬è¢«ç§°ä¸ºå†…éƒ¨å¯å˜æ€§çš„åŸå› ã€‚</p>
<h3 id="ç¤ºä¾‹å¤šçº¿ç¨‹å…±äº«å¯å˜arcmutext"><a class="header" href="#ç¤ºä¾‹å¤šçº¿ç¨‹å…±äº«å¯å˜arcmutext">ç¤ºä¾‹ï¼šå¤šçº¿ç¨‹å…±äº«å¯å˜ï¼ˆ<code>Arc&lt;Mutex&lt;T&gt;&gt;</code>ï¼‰</a></h3>
<p><strong>æ ¸å¿ƒåˆ†å·¥:</strong></p>
<ul>
<li>Arcï¼ˆ<strong>æ‰€æœ‰æƒç®¡ç†è€…</strong>ï¼‰ï¼šè§£å†³â€œ<strong>è°æ‹¥æœ‰æ•°æ®</strong>â€çš„é—®é¢˜ã€‚å®ƒè®©å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰æŒ‡å‘åŒä¸€ä¸ªå †å†…å­˜çš„æŒ‡é’ˆ</li>
<li>Mutexï¼ˆ<strong>è®¿é—®æƒé™ç®¡ç†è€…</strong>ï¼‰ï¼šè§£å†³â€œ<strong>è°èƒ½ä¿®æ”¹æ•°æ®</strong>â€çš„é—®é¢˜ã€‚å®ƒç¡®ä¿å³ä½¿å¤šä¸ªçº¿ç¨‹éƒ½æœ‰æŒ‡é’ˆï¼ŒåŒä¸€æ—¶é—´ä¹Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½çœŸæ­£ç¢°åˆ°é‡Œé¢çš„æ•°æ®</li>
</ul>
<pre class="playground"><code class="language-rust editable edition2024">use std::sync::{Arc, Mutex};
use std::thread;
fn main() {
    let counter = Arc::new(Mutex::new(0));//æœ€å¤–å±‚æ˜¯ Arcï¼Œç»™è¿™æŠŠé”åŠ ä¸Šå¼•ç”¨è®¡æ•°åŠŸèƒ½,ä¸­é—´å±‚æ˜¯ Mutexï¼Œç»™æ•°æ®åŠ ä¸Šä¸€æŠŠé”
    let mut handles = vec![];
    for _ in 0..4 {
        let c = Arc::clone(&amp;counter);//å…‹éš†çš„æ˜¯æŒ‡é’ˆåœ°å€å’Œè®¡æ•°å™¨ï¼Œé”å’Œæ•°æ®å§‹ç»ˆåªæœ‰ä¸€ä»½
        handles.push(thread::spawn(move || {
            // lock() è¿”å›ä¸€ä¸ª guardï¼šguard æ´»ç€å°±æŒæœ‰é”
            let mut guard = c.lock().unwrap();
            *guard += 1;
            // ä¸éœ€è¦æ‰‹åŠ¨å†™ unlock(), guard drop æ—¶è‡ªåŠ¨è§£é”ï¼ˆRAIIï¼‰
        }));
    }
    for h in handles {
        h.join().unwrap();
    }
    println!("counter = {}", *counter.lock().unwrap()); // 4
}
</code></pre>
<h3 id="ç¤ºä¾‹å¤šçº¿ç¨‹å…±äº«å¯å˜è¯»å¤šå†™å°‘arcrwlockt"><a class="header" href="#ç¤ºä¾‹å¤šçº¿ç¨‹å…±äº«å¯å˜è¯»å¤šå†™å°‘arcrwlockt">ç¤ºä¾‹ï¼šå¤šçº¿ç¨‹å…±äº«å¯å˜ï¼ˆè¯»å¤šå†™å°‘<code>Arc&lt;RwLock&lt;T&gt;&gt;</code>ï¼‰</a></h3>
<p><strong>æ ¸å¿ƒåˆ†å·¥:</strong></p>
<ul>
<li>Arcï¼šè§£å†³â€œ<strong>è°æ‹¥æœ‰æ•°æ®</strong>â€çš„é—®é¢˜ï¼Œç¡®ä¿å †å†…å­˜åœ°å€åœ¨æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•å‰ä¿æŒæœ‰æ•ˆã€‚</li>
<li>RwLockï¼šè§£å†³â€œ<strong>å¦‚ä½•é«˜æ•ˆè®¿é—®</strong>â€çš„é—®é¢˜ã€‚å®ƒå…è®¸ 100 ä¸ªçº¿ç¨‹åŒæ—¶è¯»å–ï¼ˆå¹¶å‘ï¼‰ï¼Œä½†åªè¦æœ‰ 1 ä¸ªçº¿ç¨‹åœ¨å†™ï¼Œå…¶ä»–äººéƒ½å¿…é¡»ç­‰å¾…ï¼ˆæ’ä»–ï¼‰ã€‚</li>
</ul>
<pre class="playground"><code class="language-rust editable edition2024">use std::sync::{Arc, RwLock};
use std::thread;
use std::time::Duration;
fn main() {
    // 1. åˆå§‹åŒ–æ•°æ®ï¼ŒArc è´Ÿè´£è·¨çº¿ç¨‹å…±äº«ï¼ŒRwLock è´Ÿè´£å¹¶å‘æƒé™
    let data = Arc::new(RwLock::new(0));
    let mut handles = vec![];
    let start_time = std::time::Instant::now();
    // 2. å¼€å¯ 5 ä¸ªè¯»è€…çº¿ç¨‹
    for i in 0..5 {
        let d = Arc::clone(&amp;data);
        handles.push(thread::spawn(move || {
            // è·å–è¯»é”ï¼šæ³¨æ„ï¼å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æˆåŠŸè·å–è¯»é”
            let _guard = d.read().unwrap();
            println!("è¯»è€… {} æ­£åœ¨è¯»å–...", i);
            // æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶çš„è¯»å–æ“ä½œï¼ˆ1ç§’ï¼‰
            thread::sleep(Duration::from_secs(1)); 
            println!("è¯»è€… {} è¯»å–å®Œæ¯•", i);
        }));
    }
    // 3. å¼€å¯ 1 ä¸ªå†™è€…çº¿ç¨‹
    let d_writer = Arc::clone(&amp;data);
    handles.push(thread::spawn(move || {
        // æ¨¡æ‹Ÿç­‰å¾…ä¸€æ®µæ—¶é—´å†å†™ï¼Œç¡®ä¿è¯»è€…ä»¬å·²ç»å…ˆæ‹¿åˆ°äº†é”
        thread::sleep(Duration::from_millis(500));
        println!("å†™è€…ï¼šå°è¯•è·å–å†™é”ï¼ˆä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰è¯»è€…è¯»å®Œï¼‰...");
        // è·å–å†™é”ï¼šå¿…é¡»ç­‰æ‰€æœ‰è¯»é”é‡Šæ”¾
        let mut w = d_writer.write().unwrap();
        *w += 1;
        println!("å†™è€…ï¼šä¿®æ”¹å®Œæ¯•ï¼");
    }));
    for h in handles {
        h.join().unwrap();
    }
    println!("--- æ€»è€—æ—¶: {:?} ---", start_time.elapsed());
}</code></pre>
<h4 id="ä»£ç é€»è¾‘æ·±åº¦æ‹†è§£"><a class="header" href="#ä»£ç é€»è¾‘æ·±åº¦æ‹†è§£">ä»£ç é€»è¾‘æ·±åº¦æ‹†è§£</a></h4>
<ul>
<li>è¯»é”å¹¶å‘ (<code>.read().unwrap()</code>)
<ul>
<li>å½“ <code>reader1</code> è°ƒç”¨ <code>read()</code> æ—¶ï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰å†™çº¿ç¨‹ï¼Œå®ƒä¼šç«‹å³è·å¾— <code>ReadGuard</code>ã€‚</li>
<li><strong>ä¼˜åŠ¿</strong>ï¼šå¦‚æœæœ‰ <code>reader2ã€reader3</code> åŒæ—¶è¿›æ¥ï¼Œåªè¦å½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰â€œå†™é”â€, å®ƒä»¬éƒ½å¯ä»¥è·å–è¯»é”ã€‚è¿™æ¯” <code>Mutex</code> å¿«å¾—å¤šï¼Œå› ä¸º <code>Mutex</code> ä¼šå¼ºåˆ¶è®©è¯»è€…ä¹Ÿæ’é˜Ÿã€‚</li>
</ul>
</li>
<li>å†™é”ç‹¬å  (<code>.write().unwrap()</code>)ï¼š
<ul>
<li>å½“ <code>writer</code> è°ƒç”¨ <code>write()</code> æ—¶ï¼Œå†™é”å…·æœ‰æ’ä»–æ€§, å®ƒå¿…é¡»ç­‰å¾…æ‰€æœ‰æ­£åœ¨è¯»å–çš„çº¿ç¨‹é‡Šæ”¾è¯»é”ï¼Œä¸”æ²¡æœ‰å…¶ä»–å†™çº¿ç¨‹åœ¨å·¥ä½œã€‚åä¹‹ï¼Œåªè¦æœ‰ä»»ä½•è¯»é”æœªé‡Šæ”¾ï¼Œå†™é”è·å–ä¹Ÿä¼šè¢«é˜»å¡ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h2 id="5-celltcopy-ç±»å‹çš„è½»é‡å†…éƒ¨å¯å˜æ€§"><a class="header" href="#5-celltcopy-ç±»å‹çš„è½»é‡å†…éƒ¨å¯å˜æ€§">5. <code>Cell&lt;T&gt;</code>ï¼š<code>Copy</code> ç±»å‹çš„è½»é‡å†…éƒ¨å¯å˜æ€§</a></h2>
<p>åœ¨æŒæ¡äº† <code>Rc</code> å’Œ <code>Arc</code> ä¹‹åï¼Œä½ å¯èƒ½å·²ç»å‘ç°å®ƒä»¬é»˜è®¤æ˜¯<strong>ä¸å¯å˜å…±äº«</strong>çš„ã€‚ä¸ºäº†åœ¨â€œä¸å¯å˜â€çš„å¤–å£³ä¸‹ä¿®æ”¹æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦<strong>å†…éƒ¨å¯å˜æ€§</strong>ï¼ˆ<code>Interior Mutability</code>ï¼‰ã€‚</p>
<p>åœ¨ <code>Rust</code> ä¸­ï¼Œå¦‚æœä½ ä½¿ç”¨æ™®é€šå¼•ç”¨ï¼Œæœ€æ€•çš„æ˜¯ï¼šâ€œ<strong>æˆ‘æ‰‹é‡Œæ‹¿ç€æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆï¼Œç»“æœåˆ«äººæŠŠæ•°æ®æ”¹äº†/åˆ äº†ï¼Œå¯¼è‡´æˆ‘æ‰‹é‡Œçš„æŒ‡é’ˆå¤±æ•ˆ</strong>â€ã€‚
ä½† <code>Cell</code> å®Œç¾é¿å¼€äº†è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºå®ƒç¦æ­¢ä½ è·å–å†…éƒ¨æ•°æ®çš„æŒ‡é’ˆï¼š</p>
<ul>
<li>æ²¡æœ‰å€Ÿç”¨ï¼šä½ è°ƒç”¨ <code>c.get()</code> æ—¶ï¼Œå®ƒç›´æ¥ç»™ä½ ä¸€ä¸ªå…¨æ–°çš„å‰¯æœ¬ã€‚ä½ æ‰‹é‡Œçš„å‰¯æœ¬å’Œ <code>Cell</code> é‡Œé¢çš„åŸå§‹æ•°æ®å·²ç»æ²¡å…³ç³»äº†ã€‚</li>
<li>éšä¾¿è¦†ç›–ï¼šæ—¢ç„¶è°ä¹Ÿæ‹¿ä¸åˆ°æŒ‡å‘ <code>Cell</code> å†…éƒ¨çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆæ— è®ºä½ è°ƒç”¨å¤šå°‘æ¬¡ <code>set</code>ï¼Œéƒ½åªæ˜¯åœ¨ä¿®æ”¹é‚£ä¸€å—å†…å­˜çš„å€¼ï¼Œä¸ä¼šç ´åä»»ä½•äººçš„æŒ‡é’ˆï¼ˆå› ä¸ºæ ¹æœ¬æ²¡äººæŒæœ‰æŒ‡é’ˆï¼‰ã€‚</li>
</ul>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li><code>Cell&lt;T&gt;</code> ä¸»è¦ç”¨äºå®ç°äº† <code>Copy</code> ç‰¹å¾çš„ç±»å‹ï¼ˆå¦‚ <code>i32, bool, f64</code> ç­‰ç®€å•ç±»å‹ï¼‰</li>
<li><code>Cell</code> çš„æ“ä½œé€»è¾‘ä¸æ˜¯â€œå€Ÿç”¨â€ï¼Œè€Œæ˜¯â€œ<strong>å€¼æ‹·è´</strong>â€ã€‚å®ƒä¸ä¼šç»™ä½ å†…éƒ¨æ•°æ®çš„å¼•ç”¨ï¼Œè€Œæ˜¯è®©ä½ æŠŠå€¼å–å‡ºæ¥æˆ–å­˜è¿›å»ã€‚</li>
<li>ä¸å…¶å®ƒæ™ºèƒ½æŒ‡é’ˆä¸åŒï¼Œ<code>Cell</code> ä¸æä¾› <code>.borrow()</code> æˆ– <code>.borrow_mut()</code> æ–¹æ³•,åªæœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠ¨ä½œï¼š
<ul>
<li><code>.get()</code>ï¼šè¿”å›å†…éƒ¨å€¼çš„ä¸€ä¸ª<strong>å…¨æ–°çš„å‰¯æœ¬</strong>ï¼ˆ<code>Copy</code>ï¼‰</li>
<li><code>.set(value)</code>ï¼šå°†æ–°å€¼æ‹·è´è¿›å»ï¼Œè¦†ç›–æ—§å€¼</li>
</ul>
</li>
<li>åº”ç”¨åœºæ™¯:
<ul>
<li><strong>ç®€å•æ ‡å¿—ä½</strong>ï¼šåœ¨ç»“æ„ä½“å†…éƒ¨å­˜å‚¨ä¸€äº›çŠ¶æ€æ ‡è®°ï¼ˆå¦‚ <code>is_valid: Cell&lt;bool&gt;</code>ï¼‰ï¼Œå³ä½¿ç»“æ„ä½“æ˜¯ä»¥ä¸å¯å˜å¼•ç”¨çš„å½¢å¼ä¼ é€’ï¼Œä¹Ÿèƒ½éšæ—¶æ›´æ–°è¿™äº›æ ‡è®°ã€‚</li>
<li><strong>æ€§èƒ½æ•æ„Ÿåœºæ™¯</strong>ï¼šå¦‚æœä½ åªéœ€è¦æ“ä½œç®€å•çš„æ•°å­—æˆ–å¸ƒå°”å€¼ï¼Œä¸”ä¸éœ€è¦è·å–å®ƒä»¬çš„å¼•ç”¨ï¼Œé€‰ <code>Cell</code> è€Œä¸æ˜¯ <code>RefCell</code>ã€‚</li>
</ul>
</li>
</ul>
<pre class="playground"><code class="language-rust editable edition2024">use std::cell::Cell;
fn main() {
    // å³ä½¿å˜é‡ c æœ¬èº«æ²¡æœ‰å£°æ˜ä¸º mut
    let c = Cell::new(10);
    // æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸å¯å˜å¼•ç”¨ä¿®æ”¹å®ƒçš„å€¼
    let c_ref1 = &amp;c;
    let c_ref2 = &amp;c;
    c_ref1.set(20); 
    c_ref2.set(30);
    println!("å½“å‰å€¼: {}", c.get()); // è¾“å‡º 30
}</code></pre>
<hr>
<h2 id="6-refcelltè¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥å†…éƒ¨å¯å˜æ€§"><a class="header" href="#6-refcelltè¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥å†…éƒ¨å¯å˜æ€§">6. <code>RefCell&lt;T&gt;</code>ï¼šè¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥ï¼ˆå†…éƒ¨å¯å˜æ€§ï¼‰</a></h2>
<p>å¦‚æœè¯´ <code>Cell&lt;T&gt;</code> æ˜¯é€šè¿‡â€œä¸ç»™ä½ æŒ‡é’ˆâ€æ¥ä¿è¯å®‰å…¨ï¼Œé‚£ä¹ˆ <code>RefCell&lt;T&gt;</code>(<code>Reference Cell</code>) å°±æ˜¯é€šè¿‡<strong>é›‡ä½£ä¸€ä¸ªè¿è¡Œæ—¶ä¿å®‰</strong>æ¥è®©ä½ å®‰å…¨åœ°æŒæœ‰æŒ‡é’ˆã€‚</p>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li>ç”¨äºé‚£äº›ä¸æ–¹ä¾¿æ‹·è´ï¼ˆé <code>Copy</code> ç±»å‹ï¼Œæ¯”å¦‚ <code>Vec</code> æˆ–è‡ªå®šä¹‰ç»“æ„ä½“ï¼‰ï¼Œä¸”ä½ éœ€è¦è·å–å…¶å¼•ç”¨çš„åœºæ™¯</li>
<li><strong>å†…éƒ¨å¯å˜æ€§ï¼ˆInterior Mutabilityï¼‰</strong> ï¼šå³ä¾¿å¤–é¢æ˜¯ä¸å¯å˜ç»‘å®šï¼Œä¹Ÿèƒ½åœ¨å†…éƒ¨ä¿®æ”¹</li>
<li>å€Ÿç”¨è§„åˆ™ä»ç¼–è¯‘æ—¶å»¶ååˆ°è¿è¡Œæ—¶ï¼š
<ul>
<li><code>borrow()</code> è·å–ä¸€ä¸ªä¸å¯å˜å¼•ç”¨, å¾—åˆ° <code>Ref&lt;T&gt;</code></li>
<li><code>borrow_mut()</code> è·å–ä¸€ä¸ªå¯å˜å¼•ç”¨, å¾—åˆ° <code>RefMut&lt;T&gt;</code></li>
<li>åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼ŒRefCell å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•å½“å‰çš„å€Ÿç”¨çŠ¶æ€,è¿è¡Œæ—¶è¿åäº†è§„åˆ™åˆ™ä¼š <strong>panic</strong></li>
</ul>
</li>
<li>ä¸ <code>Rc</code> ç»„åˆï¼š<code>Rc&lt;RefCell&lt;T&gt;&gt;</code> æ˜¯å•çº¿ç¨‹å¸¸è§å…±äº«å¯å˜æ–¹æ¡ˆ</li>
</ul>
<h3 id="ç¤ºä¾‹å…±äº«--å¯å˜å•çº¿ç¨‹"><a class="header" href="#ç¤ºä¾‹å…±äº«--å¯å˜å•çº¿ç¨‹">ç¤ºä¾‹ï¼šå…±äº« + å¯å˜ï¼ˆå•çº¿ç¨‹ï¼‰</a></h3>
<pre class="playground"><code class="language-rust editable edition2024">use std::cell::RefCell;

fn main() {
    // æ•°æ®åŒ…è£¹åœ¨ RefCell ä¸­
    let data = RefCell::new(vec![1, 2, 3]);
    // å³ä½¿ data æ˜¯ä¸å¯å˜çš„ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½è·å–å¯å˜å€Ÿç”¨
    {
        let mut mut_ref = data.borrow_mut();
        mut_ref.push(4);
    } // mut_ref åœ¨è¿™é‡Œç¦»å¼€ä½œç”¨åŸŸï¼Œå€Ÿç”¨æ ‡è®°è¢«é‡Šæ”¾
    // è·å–ä¸¤ä¸ªä¸å¯å˜å€Ÿç”¨
    let ref1 = data.borrow();
    let ref2 = data.borrow();
    println!("æ•°æ®å†…å®¹: {:?}", ref1);
}</code></pre>
<h4 id="ä¸ºä»€ä¹ˆä¼š-panicè¿åè§„åˆ™çš„åæœ"><a class="header" href="#ä¸ºä»€ä¹ˆä¼š-panicè¿åè§„åˆ™çš„åæœ">ä¸ºä»€ä¹ˆä¼š Panicï¼Ÿï¼ˆè¿åè§„åˆ™çš„åæœï¼‰</a></h4>
<p>å¦‚æœä½ å°è¯•åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸå†…åŒæ—¶è¿›è¡Œä¸å¯å˜å’Œå¯å˜å€Ÿç”¨ï¼ŒRefCell å°±ä¼šæŠ¥é”™ï¼š</p>
<pre><code class="language-rust ignore">let data = RefCell::new(5);
let r1 = data.borrow();     // è¿è¡Œæ—¶ï¼šä¸å¯å˜å€Ÿç”¨è®¡æ•° +1
let r2 = data.borrow_mut(); // è¿è¡Œæ—¶ï¼šå‘ç°å·²æœ‰ä¸å¯å˜å€Ÿç”¨ï¼Œç›´æ¥ PANICï¼</code></pre>
<h4 id="cellt-ä¸-refcellt-çš„æ·±åº¦å¯¹æ¯”"><a class="header" href="#cellt-ä¸-refcellt-çš„æ·±åº¦å¯¹æ¯”"><code>Cell&lt;T&gt;</code> ä¸ <code>RefCell&lt;T&gt;</code> çš„æ·±åº¦å¯¹æ¯”</a></h4>
<p>è¿™æ˜¯ç¬”è®°ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼š</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>ç‰¹æ€§</th><th><code>Cell&lt;T&gt;</code></th><th><code>RefCell&lt;T&gt;</code></th></tr>
</thead>
<tbody>
<tr><td><strong>é€‚ç”¨ç±»å‹</strong></td><td>å®ç°äº† <code>Copy</code> çš„ç®€å•ç±»å‹</td><td>ä»»ä½•ç±»å‹ï¼ˆé€šå¸¸æ˜¯è¾ƒå¤§çš„å¯¹è±¡ï¼‰</td></tr>
<tr><td><strong>è·å–æ–¹å¼</strong></td><td>è¿”å›å€¼çš„å‰¯æœ¬ï¼ˆ<code>.get()</code>ï¼‰</td><td>è¿”å›æ•°æ®çš„å¼•ç”¨ï¼ˆ<code>.borrow()</code>ï¼‰</td></tr>
<tr><td><strong>æ€§èƒ½å¼€é”€</strong></td><td><strong>é›¶å¼€é”€</strong>ï¼ˆä»…å†…å­˜æ‹·è´ï¼‰</td><td><strong>æœ‰å¼€é”€</strong>ï¼ˆè¿è¡Œæ—¶ç»´æŠ¤å€Ÿç”¨è®¡æ•°ï¼‰</td></tr>
<tr><td><strong>å®‰å…¨æ€§</strong></td><td>ç¼–è¯‘æ—¶å®‰å…¨ï¼ˆæ— å¼•ç”¨ï¼‰</td><td><strong>è¿è¡Œæ—¶å¯èƒ½ Panic</strong></td></tr>
<tr><td><strong>çº¿ç¨‹å®‰å…¨</strong></td><td><strong>ä¸å®‰å…¨</strong> (<code>!Sync</code>)</td><td><strong>ä¸å®‰å…¨</strong> (<code>!Sync</code>)</td></tr>
</tbody>
</table>
</div>
<h4 id="-ä¸ºä»€ä¹ˆéœ€è¦-refcell"><a class="header" href="#-ä¸ºä»€ä¹ˆéœ€è¦-refcell">ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ <code>RefCell</code>ï¼Ÿ</a></h4>
<p>æœ€å¸¸è§çš„åœºæ™¯æ˜¯ï¼š<strong>ä½ å®ç°äº†ä¸€ä¸ª Traitï¼Œè€Œè¯¥ Trait çš„æ–¹æ³•ç­¾åè¦æ±‚ä½¿ç”¨ä¸å¯å˜å¼•ç”¨ <code>&amp;self</code>ï¼Œä½†ä½ çš„å…·ä½“å®ç°å´éœ€è¦ä¿®æ”¹å†…éƒ¨çŠ¶æ€ï¼ˆæ¯”å¦‚ç¼“å­˜ã€æ—¥å¿—è®°å½•ç­‰ï¼‰</strong>ã€‚</p>
<h4 id="æ€»ç»“ä¸€å¥è¯"><a class="header" href="#æ€»ç»“ä¸€å¥è¯">æ€»ç»“ä¸€å¥è¯</a></h4>
<blockquote>
<p><strong><code>Cell</code> æ˜¯â€œæ¬å®¶â€ï¼ˆæ‹·è´å€¼ï¼‰ï¼Œ<code>RefCell</code> æ˜¯â€œç™»è®°å¤„â€ï¼ˆåœ¨è¿è¡Œæ—¶ç›¯ç€è°æ‹¿äº†é’¥åŒ™ï¼Œè¿è§„å°±æŠ¥è­¦ï¼‰ã€‚</strong></p>
</blockquote>
<h3 id="rcrefcelltå•çº¿ç¨‹å…±äº«--å¯å˜"><a class="header" href="#rcrefcelltå•çº¿ç¨‹å…±äº«--å¯å˜"><code>Rc&lt;RefCell&lt;T&gt;&gt;</code>ï¼šå•çº¿ç¨‹å…±äº« + å¯å˜</a></h3>
<p>è¿™æ˜¯ Rust å•çº¿ç¨‹å¼€å‘ä¸­æœ€å¼ºå¤§çš„<strong>ç»„åˆæ‹³</strong>ã€‚å¦‚æœä½ ç†è§£äº† <code>Rc</code>ï¼ˆè§£å†³æ‰€æœ‰æƒå…±äº«ï¼‰å’Œ <code>RefCell</code>ï¼ˆè§£å†³ä¸å¯å˜å¤–å£³ä¸‹çš„ä¿®æ”¹ï¼‰ï¼Œé‚£ä¹ˆæŠŠå®ƒä»¬å¥—åœ¨ä¸€èµ·å°±å¾—åˆ°äº†ï¼š<strong>ä¸€ä¸ªå¯ä»¥è¢«å¤šä¸ªåœ°æ–¹åŒæ—¶æŒæœ‰ã€ä¸”æ¯ä¸ªåœ°æ–¹éƒ½èƒ½ä¿®æ”¹çš„â€œå…±äº«å˜é‡â€ã€‚</strong></p>
<p>åœ¨ <code>Rust</code>ä¸­ï¼ŒæŒ‡é’ˆæ˜¯è¡¨ç¤ºå†…å­˜åœ°å€çš„ç±»å‹ã€‚ä¸ºäº†å®ç°â€œå¤šå¤„è¯»å†™â€è¿™ç§åœ¨å…¶ä»–è¯­è¨€ä¸­å¾ˆå¸¸è§çš„è¡Œä¸ºï¼Œæˆ‘ä»¬éœ€è¦è¿™ç§â€œå¥—å¨ƒâ€ç»“æ„ã€‚</p>
<h4 id="æ ¸å¿ƒé€»è¾‘"><a class="header" href="#æ ¸å¿ƒé€»è¾‘">æ ¸å¿ƒé€»è¾‘</a></h4>
<ul>
<li><strong>å¤–å±‚ <code>Rc&lt;T&gt;**</code>ï¼šè´Ÿè´£</strong>å…±äº«**ã€‚å®ƒå…è®¸å¤šä¸ªå˜é‡æŒæœ‰æŒ‡å‘åŒä¸€å—å †å†…å­˜çš„æŒ‡é’ˆï¼Œè§£å†³äº†â€œè°èƒ½æ‹¿åˆ°è¿™å—å†…å­˜â€çš„é—®é¢˜ã€‚</li>
<li><strong>å†…å±‚ <code>RefCell&lt;T&gt;**</code>ï¼šè´Ÿè´£</strong>ä¿®æ”¹**ã€‚å®ƒå…è®¸ä½ åœ¨åªæœ‰ <code>Rc</code> æä¾›çš„ä¸å¯å˜å¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡è¿è¡Œæ—¶æ£€æŸ¥æ¥ä¿®æ”¹å†…éƒ¨æ•°æ®ã€‚</li>
</ul>
<p>å½“ä½ åˆ›å»º <code>let x = Rc::new(RefCell::new(5))</code> æ—¶ï¼Œå†…å­˜ä¸­å‘ç”Ÿäº†ä»¥ä¸‹æƒ…å†µï¼š</p>
<ul>
<li><strong>æ ˆä¸Š</strong>ï¼šæœ‰ä¸€ä¸ª <code>Rc</code> æŒ‡é’ˆ</li>
<li><strong>å †ä¸Š</strong>ï¼šåˆ†é…äº†ä¸€å—ç©ºé—´ï¼ŒåŒ…å«
<ul>
<li><code>Rc</code> çš„å¼•ç”¨è®¡æ•°å™¨</li>
<li><code>RefCell</code> çš„å€Ÿç”¨çŠ¶æ€æ ‡å¿—ä½</li>
<li>å®é™…çš„æ•°æ® <code>T</code>ã€‚</li>
</ul>
</li>
</ul>
<h4 id="ä»£ç ç¤ºä¾‹å…±äº«è®¡æ•°å™¨"><a class="header" href="#ä»£ç ç¤ºä¾‹å…±äº«è®¡æ•°å™¨">ä»£ç ç¤ºä¾‹ï¼šå…±äº«è®¡æ•°å™¨</a></h4>
<pre class="playground"><code class="language-rust editable edition2024">use std::rc::Rc;
use std::cell::RefCell;
fn main() {
    // 1. åˆ›å»ºå…±äº«çš„å¯å˜æ•°æ®
    let shared_data = Rc::new(RefCell::new(vec![1, 2, 3]));
    // 2. å…‹éš† Rc æŒ‡é’ˆï¼ˆå¢åŠ å¼ºå¼•ç”¨è®¡æ•°ï¼‰
    let shared_data_clone = Rc::clone(&amp;shared_data);
    // 3. åœ¨ä¸€å¤„ä¿®æ”¹
    {
        let mut mut_ref = shared_data.borrow_mut();
        mut_ref.push(4);
    } 
    // 4. åœ¨å¦ä¸€å¤„è¯»å–ï¼Œå‘ç°æ•°æ®å·²ç»å˜äº†
    println!("å…‹éš†ç«¯çœ‹åˆ°çš„æ•°æ®: {:?}", shared_data_clone.borrow());
    // è¾“å‡º: [1, 2, 3, 4]
}
</code></pre>
<h4 id="æ·±åº¦å¯¹æ¯”å•çº¿ç¨‹-vs-å¤šçº¿ç¨‹"><a class="header" href="#æ·±åº¦å¯¹æ¯”å•çº¿ç¨‹-vs-å¤šçº¿ç¨‹">æ·±åº¦å¯¹æ¯”ï¼šå•çº¿ç¨‹ vs å¤šçº¿ç¨‹</a></h4>
<p>è¿™ä¸ªç»„åˆæœ‰ä¸€ä¸ªå®Œç¾çš„â€œå¤šçº¿ç¨‹å¯¹åº”ç‰ˆæœ¬â€ï¼Œè¯·åŠ¡å¿…è®°åœ¨ç¬”è®°ä¸­å¯¹æ¯”ï¼š</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>åœºæ™¯</th><th>å·¥å…·ç»„åˆ</th><th>é€»è¾‘</th></tr>
</thead>
<tbody>
<tr><td><strong>å•çº¿ç¨‹</strong></td><td><strong><code>Rc&lt;RefCell&lt;T&gt;&gt;</code></strong></td><td><strong>å¼•ç”¨è®¡æ•° + è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥</strong></td></tr>
<tr><td><strong>å¤šçº¿ç¨‹</strong></td><td><strong><code>Arc&lt;Mutex&lt;T&gt;&gt;</code></strong></td><td><strong>åŸå­è®¡æ•° + äº’æ–¥é”</strong></td></tr>
</tbody>
</table>
</div>
<h4 id="é£é™©è­¦ç¤ºè¿è¡Œæ—¶å´©æºƒ"><a class="header" href="#é£é™©è­¦ç¤ºè¿è¡Œæ—¶å´©æºƒ">é£é™©è­¦ç¤ºï¼šè¿è¡Œæ—¶å´©æºƒ</a></h4>
<p>è™½ç„¶è¿™ä¸ªç»„åˆå¾ˆå¼ºï¼Œä½†å®ƒä¿ç•™äº† <code>RefCell</code> çš„é£é™©ï¼š</p>
<ul>
<li>å¦‚æœä½ åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œé€šè¿‡ <code>shared_data.borrow()</code> æ‹¿åˆ°äº†ä¸€ä¸ªå¼•ç”¨è¿˜æ²¡æ”¾æ‰‹ï¼Œåˆå°è¯•ç”¨ <code>shared_data_clone.borrow_mut()</code> å»ä¿®æ”¹ï¼Œ<strong>ç¨‹åºä¼šç›´æ¥ Panic</strong>ã€‚</li>
<li>å®ƒä¾ç„¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸èƒ½è·¨çº¿ç¨‹ä¼ é€’ã€‚</li>
</ul>
<hr>
<h2 id="7-cowa-tå†™æ—¶å…‹éš†copy-on-write"><a class="header" href="#7-cowa-tå†™æ—¶å…‹éš†copy-on-write">7. <code>Cow&lt;'a, T&gt;</code>ï¼šå†™æ—¶å…‹éš†ï¼ˆCopy-On-Writeï¼‰</a></h2>
<p>è¿™æ˜¯ <code>Rust</code> ä¸­ä¸€ä¸ªéå¸¸â€œèªæ˜â€ä¸”èƒ½æ˜¾è‘—æå‡æ€§èƒ½çš„æ™ºèƒ½æŒ‡é’ˆã€‚<code>Cow</code> çš„å…¨ç§°æ˜¯ <code>Copy-On-Write</code>ï¼ˆå†™æ—¶å…‹éš†ï¼‰ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>ä¸åˆ°ä¸‡ä¸å¾—å·²ï¼Œç»ä¸åˆ†é…å†…å­˜</strong>ã€‚å°†å†…å­˜åˆ†é…<strong>æ¨è¿Ÿåˆ°çœŸæ­£å‘ç”Ÿä¿®æ”¹</strong>çš„é‚£ä¸€åˆ»ã€‚</p>
<h3 id="æ ¸å¿ƒå®šä¹‰"><a class="header" href="#æ ¸å¿ƒå®šä¹‰">æ ¸å¿ƒå®šä¹‰</a></h3>
<p><code>Cow</code> æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼ŒåŒ…å«ä¸¤ä¸ªå˜ä½“ï¼š<code>Borrowed(&amp;'a T)</code> å’Œ <code>Owned(T::Owned)</code>ã€‚å®ƒå…è®¸ä½ ä»¥ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼å¤„ç†å€Ÿç”¨çš„æ•°æ®å’Œæ‹¥æœ‰çš„æ•°æ®ã€‚</p>
<ul>
<li><code>Borrowed(&amp;'a T)</code>ï¼šæŒæœ‰æ•°æ®çš„åªè¯»å¼•ç”¨</li>
<li><code>Owned(T::Owned)</code>ï¼šæŒæœ‰æ•°æ®çš„æ‰€æœ‰æƒï¼ˆé€šå¸¸åœ¨å †ä¸Šï¼‰</li>
</ul>
<h3 id="æ‡’æƒ°æ˜¯ç¾å¾·"><a class="header" href="#æ‡’æƒ°æ˜¯ç¾å¾·">æ‡’æƒ°æ˜¯ç¾å¾·</a></h3>
<ul>
<li>åˆå§‹çŠ¶æ€: å½“ä½ åˆ›å»ºä¸€ä¸ª <code>Cow</code> æ—¶ï¼Œå®ƒé€šå¸¸ä» <code>Borrowed</code> å¼€å§‹ã€‚è¿™ä¸éœ€è¦åˆ†é…æ–°å†…å­˜ï¼Œå¼€é”€æå°ã€‚</li>
<li>è¯»å–æ•°æ®ï¼šå½“ä½ åªéœ€è¦è¯»å–æ—¶ï¼Œå®ƒä¿æŒ Borrowed çŠ¶æ€ï¼Œæ€§èƒ½æŸè€—ä¸º <code>O(1)</code>ã€‚</li>
<li>ä¿®æ”¹æ•°æ®ï¼šå½“ä½ è°ƒç”¨ <code>.to_mut()</code> å°è¯•ä¿®æ”¹æ•°æ®æ—¶ï¼Œ<code>Cow</code> ä¼šæ£€æŸ¥ï¼šå¦‚æœå·²ç»æ˜¯ <code>Owned</code>ï¼Œç›´æ¥è¿”å›å¼•ç”¨ã€‚å¦‚æœæ˜¯ <code>Borrowed</code>ï¼Œæ­¤æ—¶æ‰ä¼šæ‰§è¡Œå…‹éš†ï¼ˆ<code>Clone</code>ï¼‰ï¼Œå°†æ•°æ®å˜ä¸º <code>Owned</code>ï¼Œç„¶åå†è®©ä½ ä¿®æ”¹ã€‚</li>
</ul>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li>è¡¨ç¤ºâ€œè¦ä¹ˆå€Ÿç”¨ï¼Œè¦ä¹ˆæ‹¥æœ‰â€</li>
<li>è¯»æ“ä½œé›¶æ‹·è´ï¼Œå†™æ“ä½œæ‰ä¼š <code>to_mut()</code> è§¦å‘å…‹éš†</li>
<li>å¸¸è§åœºæ™¯ï¼šå­—ç¬¦ä¸²å¤„ç†ã€API æ—¢æ¥å— <code>&amp;str</code> åˆèƒ½è¿”å› <code>String</code> çš„ä¼˜åŒ–</li>
</ul>
<pre class="playground"><code class="language-rust editable edition2024">use std::borrow::Cow;
// å¦‚æœä¸éœ€è¦ä¿®æ”¹ï¼Œå°±å€Ÿç”¨è¾“å…¥ï¼ˆé›¶æ‹·è´ï¼‰ï¼›
// å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œå†è½¬æˆæ‹¥æœ‰çš„ Stringã€‚
fn normalize(s: &amp;str) -&gt; Cow&lt;'_, str&gt; {
    if s.contains(' ') {
        // éœ€è¦ä¿®æ”¹ï¼šåˆ†é…æ–° Stringï¼ˆOwnedï¼‰
        Cow::Owned(s.replace(' ', "_"))
    } else {
        // ä¸éœ€è¦ä¿®æ”¹ï¼šç›´æ¥å€Ÿç”¨ï¼ˆBorrowedï¼‰
        Cow::Borrowed(s)
    }
}
fn main() {
    let a = normalize("hello");
    let b = normalize("hello world");

    println!("a = {}", a);
    println!("b = {}", b);
}</code></pre>
<hr>
<h2 id="8-pinpç¦æ­¢è¢«ç§»åŠ¨è‡ªå¼•ç”¨å¼‚æ­¥"><a class="header" href="#8-pinpç¦æ­¢è¢«ç§»åŠ¨è‡ªå¼•ç”¨å¼‚æ­¥">8. <code>Pin&lt;P&gt;</code>ï¼šç¦æ­¢è¢«ç§»åŠ¨ï¼ˆè‡ªå¼•ç”¨/å¼‚æ­¥ï¼‰</a></h2>
<p>è¿™æ˜¯ Rust ä¸­æœ€â€œç„å­¦â€ä½†ä¹Ÿæœ€åº•å±‚ã€æœ€é‡è¦çš„æ™ºèƒ½æŒ‡é’ˆä¹‹ä¸€ã€‚å¦‚æœè¯´ <code>Box</code> æ˜¯ä¸ºäº†æ”¾è¿›å †é‡Œï¼Œé‚£ä¹ˆ <code>Pin</code> å°±æ˜¯ä¸ºäº†<strong>é”æ­»å†…å­˜åœ°å€</strong>ã€‚</p>
<h3 id="define"><a class="header" href="#define">Define</a></h3>
<h4 id="a-æ ¸å¿ƒå±æœºè‡ªå¼•ç”¨ç»“æ„-self-referential-structs"><a class="header" href="#a-æ ¸å¿ƒå±æœºè‡ªå¼•ç”¨ç»“æ„-self-referential-structs">A. æ ¸å¿ƒå±æœºï¼šè‡ªå¼•ç”¨ç»“æ„ (Self-referential Structs)</a></h4>
<p>åœ¨ Rust ä¸­ï¼Œå‡ ä¹æ‰€æœ‰ç±»å‹éƒ½æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼ˆ<code>Move</code>ï¼‰ã€‚è¿™æ„å‘³ç€å¦‚æœä½ æŠŠä¸€ä¸ªå˜é‡ä¼ ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„<strong>å†…å­˜åœ°å€å¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜</strong>ã€‚ä½†åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œè¿™ç§â€œç§»åŠ¨â€ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
<p>æƒ³è±¡ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒçš„ä¸€ä¸ªå­—æ®µæ˜¯æŒ‡å‘å¦ä¸€ä¸ªå­—æ®µçš„æŒ‡é’ˆï¼š</p>
<pre><code class="language-rust ignore">struct SelfRef {
    data: String,
    ptr: *const String, // è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªç»“æ„ä½“é‡Œçš„ data
}
</code></pre>
<ol>
<li><strong>åˆå§‹çŠ¶æ€</strong>ï¼š<code>ptr</code> è®°å½•äº† <code>data</code> åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼ˆæ¯”å¦‚ <code>0x100</code>ï¼‰ã€‚</li>
<li><strong>å‘ç”Ÿç§»åŠ¨</strong>ï¼šå¦‚æœä½ æŠŠè¿™ä¸ªç»“æ„ä½“ç§»åŠ¨åˆ°å †ä¸Šæˆ–è€…ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ•´ä¸ªç»“æ„ä½“çš„å†…å­˜åœ°å€å˜äº†ï¼ˆå˜æˆäº† <code>0x200</code>ï¼‰ã€‚</li>
<li><strong>ç»“æœ</strong>ï¼š<code>data</code> çš„æ–°åœ°å€æ˜¯ <code>0x200</code>ï¼Œä½† <code>ptr</code> ä»ç„¶æŒ‡ç€æ—§åœ°å€ <code>0x100</code>ã€‚<strong>æŒ‡é’ˆå¤±æ•ˆäº†ï¼</strong> è¿™ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚</li>
</ol>
<h4 id="b-pinp-çš„ä½œç”¨"><a class="header" href="#b-pinp-çš„ä½œç”¨">B. <code>Pin&lt;P&gt;</code> çš„ä½œç”¨</a></h4>
<p><code>Pin</code> çš„ä½œç”¨å°±æ˜¯ï¼š<strong>ç»™æŒ‡é’ˆåŠ ä¸€ä¸ªçº¦æŸï¼Œä¿è¯å®ƒæŒ‡å‘çš„æ•°æ®åœ¨å†…å­˜ä¸­æ°¸è¿œä¸ä¼šè¢«ç§»åŠ¨ã€‚</strong></p>
<ul>
<li>ä¸€æ—¦æ•°æ®è¢« <code>Pin</code> ä½ï¼Œä½ æ— æ³•å†é€šè¿‡ <code>mem::swap</code> æˆ–ç§»åŠ¨æ‰€æœ‰æƒç­‰æ–¹å¼æ”¹å˜å®ƒçš„ç‰©ç†ä½ç½®ã€‚</li>
<li>å®ƒä¸»è¦é…åˆ <code>P</code>ï¼ˆé€šå¸¸æ˜¯ <code>Box</code> æˆ–å¼•ç”¨ï¼‰ä½¿ç”¨ï¼Œå½¢æˆ <code>Pin&lt;Box&lt;T&gt;&gt;</code> æˆ– <code>Pin&lt;&amp;mut T&gt;</code>ã€‚</li>
</ul>
<h4 id="c-ä¸ºä»€ä¹ˆå¼‚æ­¥asyncawaitå¿…é¡»ç”¨å®ƒ"><a class="header" href="#c-ä¸ºä»€ä¹ˆå¼‚æ­¥asyncawaitå¿…é¡»ç”¨å®ƒ">C. ä¸ºä»€ä¹ˆå¼‚æ­¥ï¼ˆAsync/Awaitï¼‰å¿…é¡»ç”¨å®ƒï¼Ÿ</a></h4>
<p>è¿™æ˜¯ <code>Pin</code> æœ€ä¸»è¦çš„åº”ç”¨åœºæ™¯ã€‚</p>
<ul>
<li>å½“ä½ å†™ <code>async</code> å—æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼ˆå®ç°äº† <code>Future</code> traitï¼‰ã€‚</li>
<li>è¿™ä¸ªçŠ¶æ€æœºå†…éƒ¨ç»å¸¸åŒ…å«è‡ªå¼•ç”¨ï¼ˆä¾‹å¦‚ï¼šä¸€ä¸ªå±€éƒ¨å˜é‡è¢«å¼•ç”¨åè·¨è¶Šäº† <code>.await</code> ç‚¹ï¼‰ã€‚</li>
<li>å› æ­¤ï¼Œ<code>Future</code> çš„ <code>poll</code> æ–¹æ³•ç­¾åå¿…é¡»æ˜¯ <code>fn poll(self: Pin&lt;&amp;mut Self&gt;, ...)</code>ã€‚<strong>æ²¡æœ‰ <code>Pin</code>ï¼Œå¼‚æ­¥ä»£ç å°±æ— æ³•ä¿è¯å†…å­˜å®‰å…¨ã€‚</strong></li>
</ul>
<hr>
<h4 id="d-unpin-ç‰¹å¾è°å¯ä»¥è±å…"><a class="header" href="#d-unpin-ç‰¹å¾è°å¯ä»¥è±å…">D. <code>Unpin</code> ç‰¹å¾ï¼šè°å¯ä»¥è±å…ï¼Ÿ</a></h4>
<p>å¹¶ä¸æ˜¯æ‰€æœ‰ä¸œè¥¿éƒ½éœ€è¦è¢«â€œé”æ­»â€ã€‚Rust å®šä¹‰äº†ä¸€ä¸ªæ ‡è®°ç‰¹å¾ <strong><code>Unpin</code></strong>ï¼š</p>
<ul>
<li><strong><code>Unpin</code> ç±»å‹</strong>ï¼šç»å¤§å¤šæ•°æ™®é€šç±»å‹ï¼ˆå¦‚ <code>i32</code>, <code>String</code>, <code>Box</code>ï¼‰ã€‚å®ƒä»¬å³ä¾¿è¢«ç§»åŠ¨ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚å¯¹äºè¿™äº›ç±»å‹ï¼Œ<code>Pin&lt;P&gt;</code> æ²¡æœ‰ä»»ä½•å®é™…é™åˆ¶ï¼Œå¯ä»¥éšæ„æ‹¿å›å¯å˜å¼•ç”¨ã€‚</li>
<li><strong><code>!Unpin</code> ç±»å‹</strong>ï¼šä¸èƒ½è¢«ç§»åŠ¨çš„ç±»å‹ï¼ˆå¦‚å¼‚æ­¥ç”Ÿæˆçš„ <code>Future</code>ã€è‡ªå¼•ç”¨ç»“æ„ï¼‰ã€‚å®ƒä»¬å¿…é¡»è¢« <code>Pin</code> ä¿æŠ¤ï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šé˜»æ­¢æŸäº›å±é™©æ“ä½œã€‚</li>
</ul>
<hr>
<h4 id="å¦‚ä½•é€šä¿—ç†è§£-pin"><a class="header" href="#å¦‚ä½•é€šä¿—ç†è§£-pin">å¦‚ä½•é€šä¿—ç†è§£ <code>Pin</code>ï¼Ÿ</a></h4>
<ul>
<li><strong>æ™®é€šæŒ‡é’ˆ</strong>ï¼šåƒä¸€å¼ å†™ç€åœ°å€çš„ä¾¿ç­¾ã€‚ä½ å¯ä»¥æŠŠä¾¿ç­¾ä¼ æ¥ä¼ å»ï¼Œæˆ¿å­ï¼ˆæ•°æ®ï¼‰ä¹Ÿå¯èƒ½æ¬å®¶ã€‚</li>
<li><strong><code>Pin</code> æŒ‡é’ˆ</strong>ï¼šåƒä¸€é¢—<strong>é’‰å­</strong>ã€‚å®ƒä¸ä»…å‘Šè¯‰ä½ åœ°å€ï¼Œè¿˜å°†æˆ¿å­æ­»æ­»åœ°é’‰åœ¨åŸåœ°ï¼Œä¸å‡†æ¬å®¶ï¼Œç›´åˆ°æˆ¿å­è¢«æ‹†é™¤ï¼ˆDropï¼‰ä¸ºæ­¢ã€‚</li>
</ul>
<h4 id="é€‰å‹æŒ‡å—"><a class="header" href="#é€‰å‹æŒ‡å—">é€‰å‹æŒ‡å—</a></h4>
<ol>
<li>å¦‚æœä½ çš„æ•°æ®ä¸åŒ…å«æŒ‡å‘è‡ªèº«çš„æŒ‡é’ˆï¼Œ**ä¸éœ€è¦ <code>Pin**</code>ã€‚</li>
<li>å¦‚æœä½ åœ¨æ‰‹å†™å¤æ‚çš„ <code>Future</code> æˆ–è€…æ„å»ºè‡ªå¼•ç”¨åº•å±‚åº“ï¼Œ**å¿…é¡»ç”¨ <code>Pin**</code>ã€‚</li>
</ol>
<p>è¿™ä¸ªç¤ºä¾‹åªæ˜¯è®©ä½ çœ‹åˆ° <code>Pin&lt;Box&lt;T&gt;&gt;</code>çš„å†™æ³•ï¼›çœŸæ­£éœ€è¦ <code>Pin</code> çš„åœºæ™¯ä¸»è¦åœ¨ <code>async/Future</code> æˆ–è‡ªå¼•ç”¨ç»“æ„é‡Œã€‚</p>
<pre class="playground"><code class="language-rust editable edition2024">use std::pin::Pin;
fn main() {
    let x = Box::new(123);
    // Pin&lt;Box&lt;T&gt;&gt;ï¼šæŠŠå †ä¸Šçš„ T â€œå›ºå®šä½â€ï¼Œæ‰¿è¯ºä¹‹åä¸ä¼šå†ç§»åŠ¨å®ƒçš„å†…å­˜åœ°å€
    let pinned: Pin&lt;Box&lt;i32&gt;&gt; = Box::pin(*x);
    // è®¿é—®å†…éƒ¨å€¼ï¼šas_ref å¾—åˆ° Pin&lt;&amp;T&gt;ï¼Œget_ref æ‹¿åˆ° &amp;T
    let r: &amp;i32 = pinned.as_ref().get_ref();
    println!("pinned value = {}", r);
}</code></pre>
<hr>
<h2 id="9-boxdyn-trait--rcdyn-traittrait-object-ä¸åŠ¨æ€åˆ†å‘"><a class="header" href="#9-boxdyn-trait--rcdyn-traittrait-object-ä¸åŠ¨æ€åˆ†å‘">9. <code>Box&lt;dyn Trait&gt;</code> / <code>Rc&lt;dyn Trait&gt;</code>ï¼štrait object ä¸åŠ¨æ€åˆ†å‘</a></h2>
<p>è¿™æ˜¯ Rust æ™ºèƒ½æŒ‡é’ˆç³»åˆ—çš„æœ€åä¸€é¡¹æ ¸å¿ƒåº”ç”¨ã€‚å¦‚æœä½ éœ€è¦å¤„ç†<strong>ä¸åŒç±»å‹ä½†å®ç°äº†ç›¸åŒç‰¹å¾</strong>çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ä¸€ä¸ªæ•°ç»„é‡Œæ—¢æœ‰â€œåœ†å½¢â€åˆæœ‰â€œæ­£æ–¹å½¢â€ï¼‰ï¼Œä½ å°±å¿…é¡»ç”¨åˆ° <code>Box&lt;dyn Trait&gt;</code> æˆ– <code>Rc&lt;dyn Trait&gt;</code>ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼ŒæŒ‡é’ˆæ˜¯è¡¨ç¤ºå†…å­˜åœ°å€çš„ç±»å‹ã€‚ç”±äºä¸åŒç±»å‹çš„å¤§å°ä¸åŒï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨æ ˆä¸Šå­˜å‚¨â€œæŸä¸ªç‰¹å¾â€ï¼Œå¿…é¡»é€šè¿‡æ™ºèƒ½æŒ‡é’ˆå°†å…¶åŒ…è£…æˆ <strong>Trait Object</strong>ã€‚</p>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li><strong>é™æ€åˆ†å‘ï¼ˆæ³›å‹ï¼‰ vs åŠ¨æ€åˆ†å‘ï¼ˆtrait objectï¼‰</strong></li>
<li>å¯¹è±¡å®‰å…¨ï¼ˆobject safetyï¼‰é™åˆ¶ï¼šå“ªäº› trait èƒ½å˜æˆ <code>dyn Trait</code></li>
<li>fat pointerï¼ˆæ•°æ®æŒ‡é’ˆ + vtableï¼‰ï¼Œå¤§å°/æ€§èƒ½ç›´è§‰</li>
</ul>
<h3 id="å‰ç½®çŸ¥è¯†"><a class="header" href="#å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</a></h3>
<h4 id="a-ä¸ºä»€ä¹ˆå¿…é¡»ç”¨-box-æˆ–-rc"><a class="header" href="#a-ä¸ºä»€ä¹ˆå¿…é¡»ç”¨-box-æˆ–-rc">A. ä¸ºä»€ä¹ˆå¿…é¡»ç”¨ <code>Box</code> æˆ– <code>Rc</code>ï¼Ÿ</a></h4>
<p>ç‰¹å¾ï¼ˆTraitï¼‰æœ¬èº«æ˜¯ <strong>DST (Dynamically Sized Type)</strong>ï¼Œå³â€œåŠ¨æ€å¤§å°ç±»å‹â€ã€‚</p>
<ul>
<li>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶ä¸çŸ¥é“å…·ä½“æ˜¯å“ªä¸ªç»“æ„ä½“å®ç°äº†è¯¥ç‰¹å¾ï¼Œå› æ­¤ä¸çŸ¥é“å®ƒå ç”¨å¤šå°‘å†…å­˜ã€‚</li>
<li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå°†å¯¹è±¡æ”¾å…¥å †ä¸­ã€‚<code>Box&lt;dyn Trait&gt;</code> çš„å¤§å°æ˜¯å›ºå®šçš„ï¼ˆæŒ‡é’ˆå¤§å°ï¼‰ï¼Œæ— è®ºå †ä¸Šçš„å¯¹è±¡å®é™…æœ‰å¤šå¤§ã€‚</li>
</ul>
<h4 id="b-ç‰©ç†ç»“æ„èƒ–æŒ‡é’ˆ-fat-pointer"><a class="header" href="#b-ç‰©ç†ç»“æ„èƒ–æŒ‡é’ˆ-fat-pointer">B. ç‰©ç†ç»“æ„ï¼šèƒ–æŒ‡é’ˆ (Fat Pointer)</a></h4>
<p>å½“ä½ ä½¿ç”¨ <code>Box&lt;dyn Trait&gt;</code> æ—¶ï¼Œè¿™ä¸ªæŒ‡é’ˆåœ¨æ ˆä¸Šå ç”¨ <strong>2 ä¸ªå•å…ƒ</strong>ï¼ˆé€šå¸¸æ˜¯ 16 å­—èŠ‚ï¼‰ï¼š</p>
<ol>
<li><strong>æ•°æ®æŒ‡é’ˆ</strong>ï¼šæŒ‡å‘å †å†…å­˜ä¸­å…·ä½“çš„å¯¹è±¡æ•°æ®ã€‚</li>
<li><strong>vtable æŒ‡é’ˆ</strong>ï¼šæŒ‡å‘ä¸€ä¸ªâ€œè™šå‡½æ•°è¡¨â€ã€‚è¡¨ä¸­è®°å½•äº†è¯¥ç‰¹å®šç±»å‹å®ç°è¯¥ Trait çš„æ–¹æ³•åœ°å€ã€‚</li>
</ol>
<h4 id="c-é™æ€åˆ†å‘-vs-åŠ¨æ€åˆ†å‘"><a class="header" href="#c-é™æ€åˆ†å‘-vs-åŠ¨æ€åˆ†å‘">C. é™æ€åˆ†å‘ vs åŠ¨æ€åˆ†å‘</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>ç‰¹æ€§</th><th>é™æ€åˆ†å‘ (Generics <code>&lt;T: Trait&gt;</code>)</th><th>åŠ¨æ€åˆ†å‘ (<code>dyn Trait</code>)</th></tr>
</thead>
<tbody>
<tr><td><strong>åŸç†</strong></td><td>ç¼–è¯‘æ—¶ä¸ºæ¯ç§ç±»å‹ç”Ÿæˆä¸€ä»½ä»£ç ï¼ˆå•æ€åŒ–ï¼‰ã€‚</td><td>è¿è¡Œæ—¶é€šè¿‡ vtable æŸ¥æ‰¾å‡½æ•°åœ°å€ã€‚</td></tr>
<tr><td><strong>æ€§èƒ½</strong></td><td><strong>æå¿«</strong>ã€‚ç¼–è¯‘å™¨å¯ä»¥è¿›è¡Œå†…è”ä¼˜åŒ–ã€‚</td><td><strong>ç•¥æ…¢</strong>ã€‚å­˜åœ¨æŒ‡é’ˆè·³è½¬å¼€é”€ï¼Œæ— æ³•å†…è”ã€‚</td></tr>
<tr><td><strong>çµæ´»æ€§</strong></td><td>é›†åˆä¸­åªèƒ½å­˜åŒä¸€ç§ç±»å‹ã€‚</td><td><strong>æé«˜</strong>ã€‚é›†åˆä¸­å¯ä»¥å­˜å¤šç§ä¸åŒç±»å‹ã€‚</td></tr>
</tbody>
</table>
</div>
<h4 id="d-ä»£ç ç¤ºä¾‹ä¸åŒç±»å‹çš„ç»˜å›¾"><a class="header" href="#d-ä»£ç ç¤ºä¾‹ä¸åŒç±»å‹çš„ç»˜å›¾">D. ä»£ç ç¤ºä¾‹ï¼šä¸åŒç±»å‹çš„â€œç»˜å›¾â€</a></h4>
<pre class="playground"><code class="language-rust editable edition2024">trait Draw {
    fn draw(&amp;self);
}

struct Button { width: u32 }
impl Draw for Button {
    fn draw(&amp;self) { println!("æ¸²æŸ“æŒ‰é’®ï¼Œå®½åº¦: {}", self.width); }
}

struct Image { url: String }
impl Draw for Image {
    fn draw(&amp;self) { println!("æ¸²æŸ“å›¾ç‰‡ï¼Œæºè‡ª: {}", self.url); }
}

fn main() {
    // ä½¿ç”¨ Box&lt;dyn Draw&gt; å­˜å‚¨ä¸åŒç±»å‹çš„å¯¹è±¡
    let components: Vec&lt;Box&lt;dyn Draw&gt;&gt; = vec![
        Box::new(Button { width: 100 }),
        Box::new(Image { url: String::from("logo.png") }),
    ];

    for comp in components {
        comp.draw(); // è¿è¡Œæ—¶åŠ¨æ€åˆ†å‘ï¼šæŸ¥è¡¨å¹¶è°ƒç”¨å¯¹åº”æ–¹æ³•
    }
}
</code></pre>
<h3 id="ä»€ä¹ˆæ—¶å€™ç”¨-boxdyn-trait"><a class="header" href="#ä»€ä¹ˆæ—¶å€™ç”¨-boxdyn-trait">ä»€ä¹ˆæ—¶å€™ç”¨ <code>Box&lt;dyn Trait&gt;</code>ï¼Ÿ</a></h3>
<ol>
<li><strong>å¼‚è´¨é›†åˆ</strong>ï¼šå½“ä½ éœ€è¦ä¸€ä¸ª <code>Vec</code> å­˜å‚¨å¤šç§å®ç°äº†ç›¸åŒæ¥å£çš„ç±»å‹æ—¶ã€‚</li>
<li><strong>è§£è€¦</strong>ï¼šå½“ä½ ä¸æƒ³åœ¨å‡½æ•°ç­¾åä¸­æš´éœ²å…·ä½“ç±»å‹ï¼Œåªæƒ³è¡¨è¾¾â€œåªè¦å®ç°äº†è¿™ä¸ªç‰¹å¾å°±è¡Œâ€æ—¶ã€‚</li>
<li><strong>å‡å°‘ç¼–è¯‘æ—¶é—´</strong>ï¼šæ³›å‹ä¼šå¯¼è‡´ä»£ç è†¨èƒ€ï¼ˆå•æ€åŒ–ï¼‰ï¼Œè€Œ <code>dyn Trait</code> åªæœ‰ä¸€ä»½ä»£ç ï¼Œå¯ä»¥ç¼©çŸ­å¤§å‹é¡¹ç›®çš„ç¼–è¯‘æ—¶é—´ã€‚</li>
</ol>
<hr>
<h2 id="10-è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆè¿›é˜¶"><a class="header" href="#10-è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆè¿›é˜¶">10. è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆï¼ˆè¿›é˜¶ï¼‰</a></h2>
<p>ä½ è¦ä¼šçš„ç‚¹ï¼š</p>
<ul>
<li>å¦‚ä½•å®ç°è‡ªå·±çš„æŒ‡é’ˆç±»å‹ï¼š
<ul>
<li>å®ç° <code>Deref/DerefMut</code>ï¼Œè®©å®ƒåƒå¼•ç”¨ä¸€æ ·ç”¨</li>
<li>å®ç° <code>Drop</code>ï¼Œåœ¨é‡Šæ”¾æ—¶æ‰§è¡Œèµ„æºå›æ”¶</li>
</ul>
</li>
<li>RAII æ¨¡å¼ï¼ˆæ–‡ä»¶å¥æŸ„ã€ç½‘ç»œè¿æ¥ã€é”å®ˆå«ç­‰ï¼‰</li>
<li><code>PhantomData</code>ï¼ˆç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨â€œæˆ‘é€»è¾‘ä¸Šæ‹¥æœ‰/å€Ÿç”¨æŸä¸ª Tâ€ï¼Œå½±å“ drop check/varianceï¼‰â€”â€”åé«˜çº§ï¼Œä½†æ™ºèƒ½æŒ‡é’ˆå†™å¤šäº†ä¼šé‡åˆ°</li>
</ul>
<p>è¦è‡ªå®šä¹‰ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œæœ¬è´¨ä¸Šæ˜¯åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œå¹¶ä¸ºå®ƒå®ç°ä¸¤ä¸ªæ ¸å¿ƒç‰¹å¾ï¼ˆTraitï¼‰ï¼š<strong><code>Deref</code></strong> å’Œ <strong><code>Drop</code></strong>ã€‚åœ¨ Rust ä¸­ï¼Œæ­£æ˜¯è¿™ä¸¤ä¸ªç‰¹å¾è®©æ™®é€šç»“æ„ä½“æ‹¥æœ‰äº†â€œåƒæŒ‡é’ˆä¸€æ ·å·¥ä½œâ€å’Œâ€œè‡ªåŠ¨ç®¡ç†èµ„æºâ€çš„è¶…èƒ½åŠ›ã€‚</p>
<h3 id="1-è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆçš„æ ¸å¿ƒå…¬å¼"><a class="header" href="#1-è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆçš„æ ¸å¿ƒå…¬å¼">1. è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆçš„æ ¸å¿ƒå…¬å¼</a></h3>
<ul>
<li><strong><code>Deref</code> ç‰¹å¾</strong>ï¼šå…è®¸ä½ é€šè¿‡è§£å¼•ç”¨æ“ä½œç¬¦ï¼ˆ<code>*</code>ï¼‰è®¿é—®å†…éƒ¨æ•°æ®ã€‚</li>
<li><strong><code>Drop</code> ç‰¹å¾</strong>ï¼šå®šä¹‰å½“æŒ‡é’ˆç¦»å¼€ä½œç”¨åŸŸæ—¶è¯¥æ‰§è¡Œä»€ä¹ˆæ¸…ç†é€»è¾‘ï¼ˆä¾‹å¦‚é‡Šæ”¾å†…å­˜ã€å…³é—­æ–‡ä»¶ã€æ‰“å°æ—¥å¿—ï¼‰ã€‚</li>
</ul>
<h3 id="2-å®æˆ˜æ¼”ç»ƒåˆ›å»ºä¸€ä¸ªç®€å•çš„-myboxt"><a class="header" href="#2-å®æˆ˜æ¼”ç»ƒåˆ›å»ºä¸€ä¸ªç®€å•çš„-myboxt">2. å®æˆ˜æ¼”ç»ƒï¼šåˆ›å»ºä¸€ä¸ªç®€å•çš„ <code>MyBox&lt;T&gt;</code></a></h3>
<p>æˆ‘ä»¬å°†æ¨¡ä»¿ <code>Box&lt;T&gt;</code> çš„è¡Œä¸ºï¼Œåˆ›å»ºä¸€ä¸ªèƒ½åŒ…è£¹æ•°æ®çš„æ™ºèƒ½æŒ‡é’ˆã€‚</p>
<pre class="playground"><code class="language-rust editable edition2024">use std::ops::Deref;

//A. å®šä¹‰ç»“æ„ä½“
struct MyBox&lt;T&gt;(T); // å…ƒç»„ç»“æ„ä½“
impl&lt;T&gt; MyBox&lt;T&gt; {
    fn new(x: T) -&gt; MyBox&lt;T&gt; {
        MyBox(x)
    }
}

//B. å®ç° `Deref` (è®©å®ƒèƒ½è¢« `*` è§£å¼•ç”¨)
//å¦‚æœä¸å®ç° `Deref`ï¼Œç¼–è¯‘å™¨å°±ä¸çŸ¥é“æ‰§è¡Œ `*my_box` æ—¶è¯¥è¿”å›ä»€ä¹ˆã€‚
impl&lt;T&gt; Deref for MyBox&lt;T&gt; {
    type Target = T; // å…³è”ç±»å‹ï¼ŒæŒ‡å®šè§£å¼•ç”¨åå¾—åˆ°çš„ç±»å‹
    fn deref(&amp;self) -&gt; &amp;Self::Target {
        &amp;self.0 // è¿”å›å…ƒç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¼•ç”¨
    }
}
//C. å®ç° `Drop` (èµ‹äºˆå®ƒè‡ªåŠ¨æ¸…ç†çš„èƒ½åŠ›)
impl&lt;T&gt; Drop for MyBox&lt;T&gt; {
    fn drop(&amp;mut self) {
        println!("MyBox æŒ‡é’ˆè¢«é”€æ¯äº†ï¼Œèµ„æºå·²é‡Šæ”¾ï¼");
    }
}

fn main() {
    let x = 5;
    let y = MyBox::new(x);
    assert_eq!(5, x);
    assert_eq!(5, *y); // è¿™é‡Œè§¦å‘äº† y.deref()
    println!("y çš„å€¼æ˜¯: {}", *y);
} // y åœ¨è¿™é‡Œç¦»å¼€ä½œç”¨åŸŸï¼Œè§¦å‘ drop() æ–¹æ³•</code></pre>
<h3 id="3-æ·±åº¦åŸç†deref-å¼ºåˆ¶è½¬æ¢-deref-coercion"><a class="header" href="#3-æ·±åº¦åŸç†deref-å¼ºåˆ¶è½¬æ¢-deref-coercion">3. æ·±åº¦åŸç†ï¼šDeref å¼ºåˆ¶è½¬æ¢ (Deref Coercion)</a></h3>
<p>è¿™æ˜¯ Rust æ™ºèƒ½æŒ‡é’ˆæå…¶å¥½ç”¨çš„ç§˜å¯†æ­¦å™¨ã€‚<strong>Deref å¼ºåˆ¶è½¬æ¢</strong>å¯ä»¥å°†ä¸€ä¸ªå®ç°äº† <code>Deref</code> çš„ç±»å‹çš„å¼•ç”¨è½¬æ¢ä¸ºå®ƒå†…éƒ¨ç±»å‹çš„å¼•ç”¨ã€‚</p>
<p><strong>ä¾‹å­ï¼š</strong>
å¦‚æœä½ æœ‰ä¸€ä¸ª <code>MyBox&lt;String&gt;</code>ï¼ŒRust å¯ä»¥è‡ªåŠ¨å°†å…¶è½¬æ¢ä¸º <code>&amp;str</code>ï¼š</p>
<pre><code class="language-rust ignore">fn hello(name: &amp;str) {
    println!("Hello, {}!", name);
}
fn main() {
    let m = MyBox::new(String::from("Rust"));
    // &amp;m æ˜¯ &amp;MyBox&lt;String&gt;
    // Rust è‡ªåŠ¨è°ƒç”¨ deref å°†å…¶å˜ä¸º &amp;String
    // String ä¹Ÿå®ç°äº† Derefï¼Œå†æ¬¡è°ƒç”¨ deref å˜ä¸º &amp;str
    hello(&amp;m); 
}</code></pre>
<hr>
<h2 id="11-é€‰æ‹©æŒ‡å—"><a class="header" href="#11-é€‰æ‹©æŒ‡å—">11. é€‰æ‹©æŒ‡å—</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>éœ€æ±‚åœºæ™¯</th><th>æ¨èæŒ‡é’ˆ</th><th>å¤‡æ³¨</th></tr>
</thead>
<tbody>
<tr><td><strong>å †åˆ†é…ã€å¤§æ•°æ®ä¼ é€’ã€é€’å½’ç±»å‹</strong></td><td><strong><code>Box&lt;T&gt;</code></strong></td><td>å”¯ä¸€æ‰€æœ‰æƒï¼Œå¼€é”€æœ€ä½ã€‚</td></tr>
<tr><td><strong>å•çº¿ç¨‹ã€å¤šå¤„å…±äº«åªè¯»æ•°æ®</strong></td><td><strong><code>Rc&lt;T&gt;</code></strong></td><td>å¼•ç”¨è®¡æ•°ã€‚</td></tr>
<tr><td><strong>å¤šçº¿ç¨‹ã€å¤šå¤„å…±äº«åªè¯»æ•°æ®</strong></td><td><strong><code>Arc&lt;T&gt;</code></strong></td><td>åŸå­å¼•ç”¨è®¡æ•°ï¼Œçº¿ç¨‹å®‰å…¨ã€‚</td></tr>
<tr><td><strong>å•çº¿ç¨‹ã€å°å¯¹è±¡å†…éƒ¨å¯å˜ (Copyç±»å‹)</strong></td><td><strong><code>Cell&lt;T&gt;</code></strong></td><td>get/set å€¼æ‹·è´ã€‚</td></tr>
<tr><td><strong>å•çº¿ç¨‹ã€å¤§å¯¹è±¡å†…éƒ¨å¯å˜ (éCopy)</strong></td><td><strong><code>RefCell&lt;T&gt;</code></strong></td><td>è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥ã€‚</td></tr>
<tr><td><strong>å•çº¿ç¨‹ã€å¤šæ‰€æœ‰æƒå…±äº«ä¸”å¯ä¿®æ”¹</strong></td><td><strong><code>Rc&lt;RefCell&lt;T&gt;&gt;</code></strong></td><td>ç»å…¸å¥—å¨ƒç»„åˆã€‚</td></tr>
<tr><td><strong>å¤šçº¿ç¨‹ã€å…±äº«ä¸”å¯ä¿®æ”¹</strong></td><td><strong><code>Arc&lt;Mutex&lt;T&gt;&gt;</code></strong></td><td>å¹¶å‘é»„é‡‘æ­æ¡£ã€‚</td></tr>
<tr><td><strong>é¿å…å¾ªç¯å¼•ç”¨ã€å†…å­˜æ³„æ¼</strong></td><td><strong><code>Weak&lt;T&gt;</code></strong></td><td>é…åˆ Rc æˆ– Arc ä½¿ç”¨ã€‚</td></tr>
<tr><td><strong>æ€§èƒ½ä¼˜åŒ–ã€æŒ‰éœ€å…‹éš†</strong></td><td><strong><code>Cow&lt;T&gt;</code></strong></td><td>å†™æ—¶å…‹éš†ã€‚</td></tr>
<tr><td><strong>å¼‚æ­¥ç¼–ç¨‹ã€é”æ­»å†…å­˜åœ°å€</strong></td><td><strong><code>Pin&lt;P&gt;</code></strong></td><td>é˜²æ­¢è‡ªå¼•ç”¨ç»“æ„ç§»åŠ¨ã€‚</td></tr>
</tbody>
</table>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../Rustå­¦ä¹ /åŸºç¡€è¯­æ³•/trait.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../../Rustå­¦ä¹ /åŸºç¡€è¯­æ³•/ç”Ÿå‘½å‘¨æœŸ.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../Rustå­¦ä¹ /åŸºç¡€è¯­æ³•/trait.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../../Rustå­¦ä¹ /åŸºç¡€è¯­æ³•/ç”Ÿå‘½å‘¨æœŸ.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace-2a3cd908.js"></script>
        <script src="../../mode-rust-2c9d5c9a.js"></script>
        <script src="../../editor-16ca416c.js"></script>
        <script src="../../theme-dawn-4493f9c8.js"></script>
        <script src="../../theme-tomorrow_night-9dbe62a9.js"></script>

        <script src="../../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../../mark-09e88c2c.min.js"></script>
        <script src="../../searcher-c2a407aa.js"></script>

        <script src="../../clipboard-1626706a.min.js"></script>
        <script src="../../highlight-abc7f01d.js"></script>
        <script src="../../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
